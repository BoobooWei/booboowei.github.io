<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns#">
  <meta charset="utf-8">
  <title>实施基于MyCAT的分布式数据库架构PXC + MMS + MyCAT + HAproxy + Keepalived | BoobooWei</title>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Canonical links -->
  <link rel="canonical" href="http://www.toberoot.com/database/mysql/dba_mysql/mycat/%E5%9F%BA%E4%BA%8EMyCAT%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9E%B6%E6%9E%84">
  <!-- Alternate links -->
  
    
      
    
    <link rel="alternate" hreflang="x-default" href="http://www.toberoot.com/database/mysql/dba_mysql/mycat/%E5%9F%BA%E4%BA%8EMyCAT%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9E%B6%E6%9E%84" />
  
  <!-- Icon -->
  <link rel="apple-touch-icon" sizes="57x57" href="../../../../icon/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="114x114" href="../../../../icon/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="72x72" href="../../../../icon/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="144x144" href="../../../../icon/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="60x60" href="../../../../icon/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="120x120" href="../../../../icon/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="76x76" href="../../../../icon/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="152x152" href="../../../../icon/apple-touch-icon-152x152.png">
  <link rel="icon" type="image/png" href="../../../../icon/favicon-196x196.png" sizes="196x196">
  <link rel="icon" type="image/png" href="../../../../icon/favicon-160x160.png" sizes="160x160">
  <link rel="icon" type="image/png" href="../../../../icon/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="../../../../icon/favicon-16x16.png" sizes="16x16">
  <link rel="icon" type="image/png" href="../../../../icon/favicon-32x32.png" sizes="32x32">
  <meta name="msapplication-TileColor" content="#2f83cd">
  <meta name="msapplication-TileImage" content="../../../../icon/mstile-144x144.png">
  <!-- CSS -->
  <!-- build:css build/css/navy.css -->
  
<link rel="stylesheet" href="../../../../css/navy.css">

  <!-- endbuild -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-lato@0.0.75/index.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css">
  <!-- RSS -->
  <link rel="alternate" href="../../../../atom.xml" title="BoobooWei" type="application/atom+xml">
  <!-- Open Graph -->
  <meta name="description" content="该文档注重搭建的实战，若需要学习每一个组件的原理可以参考最后的链接     1 架构图 2 服务和节点规划 3 软件准备 4 PXC集群的搭建 4.1 安装软件 4.2 pxc_node1 4.2.1 配置文件 4.4.2 启动服务 4.2.3 修改初始密码 4.2.3.1 密码修改失败处理   4.2.4 查看集群状态   4.3 pxc_node2 4.3.1 配置文件 4.3.2 启动服务">
<meta property="og:type" content="website">
<meta property="og:title" content="实施基于MyCAT的分布式数据库架构PXC + MMS + MyCAT + HAproxy + Keepalived">
<meta property="og:url" content="http://www.toberoot.com/database/mysql/dba_mysql/mycat/%E5%9F%BA%E4%BA%8EMyCAT%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9E%B6%E6%9E%84">
<meta property="og:site_name" content="BoobooWei">
<meta property="og:description" content="该文档注重搭建的实战，若需要学习每一个组件的原理可以参考最后的链接     1 架构图 2 服务和节点规划 3 软件准备 4 PXC集群的搭建 4.1 安装软件 4.2 pxc_node1 4.2.1 配置文件 4.4.2 启动服务 4.2.3 修改初始密码 4.2.3.1 密码修改失败处理   4.2.4 查看集群状态   4.3 pxc_node2 4.3.1 配置文件 4.3.2 启动服务">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://www.toberoot.com/icon/og-image-wide.png">
<meta property="article:published_time" content="2025-10-22T08:53:55.825Z">
<meta property="article:modified_time" content="2025-10-22T08:49:11.780Z">
<meta property="article:author" content="魏亚萍">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://www.toberoot.com/icon/twitter-summary.png">
<meta property="fb:admins" content="100000247608790">
  <!-- Google Analytics -->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-48498357-3', 'auto');
  ga('send', 'pageview');
</script>

  <!-- Algolia -->
  <link rel="preconnect" href="https://-dsn.algolia.net" crossorigin />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3">
<meta name="generator" content="Hexo 8.0.0"></head>

<body>
  <div id="container">
    <header id="header" class="wrapper">
  <div id="header-inner" class="inner">
    <h1 id="logo-wrap">
      <a href="../../../../" id="logo">Hexo</a>
    </h1>
    <nav id="main-nav">
      <a href="../../../../docs/" class="main-nav-link">Hexo</a><a href="../../../../news/" class="main-nav-link">News</a><a href="../../../../api/" class="main-nav-link">MySQL8.0</a><a href="../../../../database/" class="main-nav-link">Database</a><a href="../../../../linux/" class="main-nav-link">Linux</a><a href="../../../../cloud/" class="main-nav-link">Cloud</a><a href="../../../../singapore/" class="main-nav-link">Singapore</a><a href="../../../../amy/" class="main-nav-link">AMY</a><a href="../../../../about/" class="main-nav-link">About</a>
      <a target="_blank" rel="noopener" href="https://github.com/BoobooWei" class="main-nav-link"><i class="fa fa-github-alt"></i></a>

      <div id="search-input-wrap">
        <div id="search-input-icon">
          <i class="fa fa-search"></i>
        </div>
        <input type="search" id="search-input" placeholder="Search...">
      </div>
    </nav>
    <div id="lang-select-wrap">
        <a href="/about/" class="main-nav-link"><label id="lang-select-label"><i class="fa fa-globe"></i><span>关于我</span></label></a>
    </div>
    <a id="mobile-nav-toggle">
      <span class="mobile-nav-toggle-bar"></span>
      <span class="mobile-nav-toggle-bar"></span>
      <span class="mobile-nav-toggle-bar"></span>
    </a>
  </div>
</header>

    <div id="content-wrap">
  <div id="content" class="wrapper">
    <div id="content-inner">
      <article class="article-container" itemscope itemtype="http://schema.org/Article">
        <div class="article-inner">
          <div class="article">
            <div class="inner">
              <header class="article-header">
                <h1 class="article-title" itemprop="name">实施基于MyCAT的分布式数据库架构PXC + MMS + MyCAT + HAproxy + Keepalived</h1>
                <a target="_blank" rel="noopener" href="https://github.com/BoobooWei/site/edit/master/source/database/mysql/dba_mysql/mycat/基于MyCAT的分布式数据库架构.md" class="article-edit-link" title="Improve this doc"><i class="fa fa-pencil"></i></a>
              </header>
              <div class="article-content" itemprop="articleBody">
                <html><head></head><body><blockquote>
<p>该文档注重搭建的实战，若需要学习每一个组件的原理可以参考最后的链接</p>
</blockquote>
<!-- MDTOC maxdepth:6 firsth1:1 numbering:0 flatten:0 bullets:1 updateOnSave:1 -->

<ul>
<li><a href="#1-%E6%9E%B6%E6%9E%84%E5%9B%BE">1 架构图</a></li>
<li><a href="#2-%E6%9C%8D%E5%8A%A1%E5%92%8C%E8%8A%82%E7%82%B9%E8%A7%84%E5%88%92">2 服务和节点规划</a></li>
<li><a href="#3-%E8%BD%AF%E4%BB%B6%E5%87%86%E5%A4%87">3 软件准备</a></li>
<li><a href="#4-pxc%E9%9B%86%E7%BE%A4%E7%9A%84%E6%90%AD%E5%BB%BA">4 PXC集群的搭建</a><ul>
<li><a href="#41-%E5%AE%89%E8%A3%85%E8%BD%AF%E4%BB%B6">4.1 安装软件</a></li>
<li><a href="#42-pxc_node1">4.2 pxc_node1</a><ul>
<li><a href="#421-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">4.2.1 配置文件</a></li>
<li><a href="#442-%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1">4.4.2 启动服务</a></li>
<li><a href="#423-%E4%BF%AE%E6%94%B9%E5%88%9D%E5%A7%8B%E5%AF%86%E7%A0%81">4.2.3 修改初始密码</a><ul>
<li><a href="#4231-%E5%AF%86%E7%A0%81%E4%BF%AE%E6%94%B9%E5%A4%B1%E8%B4%A5%E5%A4%84%E7%90%86">4.2.3.1 密码修改失败处理</a></li>
</ul>
</li>
<li><a href="#424-%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81">4.2.4 查看集群状态</a></li>
</ul>
</li>
<li><a href="#43-pxc_node2">4.3 pxc_node2</a><ul>
<li><a href="#431-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">4.3.1 配置文件</a></li>
<li><a href="#432-%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1">4.3.2 启动服务</a></li>
<li><a href="#433-%E4%BF%AE%E6%94%B9%E5%88%9D%E5%A7%8B%E5%AF%86%E7%A0%81">4.3.3 修改初始密码</a></li>
<li><a href="#434-%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81">4.3.4 查看集群状态</a></li>
</ul>
</li>
<li><a href="#44-pxc_node3">4.4 pxc_node3</a><ul>
<li><a href="#441-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">4.4.1 配置文件</a></li>
<li><a href="#442-%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1">4.4.2 启动服务</a></li>
<li><a href="#443-%E4%BF%AE%E6%94%B9%E5%88%9D%E5%A7%8B%E5%AF%86%E7%A0%81">4.4.3 修改初始密码</a></li>
<li><a href="#444-%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81">4.4.4 查看集群状态</a></li>
<li><a href="#445-%E9%9B%86%E7%BE%A4%E5%AE%95%E6%9C%BA%E5%90%8E%E9%87%8D%E5%90%AF">4.4.5 集群宕机后重启</a></li>
</ul>
</li>
<li><a href="#45-%E9%AA%8C%E8%AF%81%E7%BB%93%E6%9E%9C">4.5 验证结果</a></li>
</ul>
</li>
<li><a href="#5-mms%E9%AB%98%E5%8F%AF%E7%94%A8%E6%90%AD%E5%BB%BA">5 MMS高可用搭建</a><ul>
<li><a href="#51-mms_mastera">5.1 mms_mastera</a><ul>
<li><a href="#511-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">5.1.1 配置文件</a></li>
<li><a href="#512-%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1">5.1.2 启动服务</a></li>
<li><a href="#513-%E4%BF%AE%E6%94%B9%E5%88%9D%E5%A7%8B%E5%AF%86%E7%A0%81">5.1.3 修改初始密码</a></li>
<li><a href="#514-%E6%B7%BB%E5%8A%A0%E6%8E%88%E6%9D%83">5.1.4 添加授权</a></li>
<li><a href="#515-%E6%9F%A5%E7%9C%8Bbinlog%E4%BD%8D%E7%BD%AE">5.1.5 查看binlog位置</a></li>
</ul>
</li>
<li><a href="#52-mms_masterb">5.2 mms_masterb</a><ul>
<li><a href="#521-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">5.2.1 配置文件</a></li>
<li><a href="#522-%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1">5.2.2 启动服务</a></li>
<li><a href="#523-%E4%BF%AE%E6%94%B9%E5%88%9D%E5%A7%8B%E5%AF%86%E7%A0%81">5.2.3 修改初始密码</a></li>
<li><a href="#524-%E6%B7%BB%E5%8A%A0%E6%8E%88%E6%9D%83">5.2.4 添加授权</a></li>
<li><a href="#525-%E5%AE%A3%E5%91%8A%E4%B8%BB%E5%BA%93">5.2.5 宣告主库</a></li>
<li><a href="#526-%E5%90%AF%E5%8A%A8%E4%BB%8E%E6%9C%8D%E5%8A%A1">5.2.6 启动从服务</a></li>
<li><a href="#527-%E6%9F%A5%E7%9C%8B%E4%BB%8E%E6%9C%8D%E5%8A%A1%E7%8A%B6%E6%80%81">5.2.7 查看从服务状态</a></li>
<li><a href="#528-%E6%9F%A5%E7%9C%8Bbinlog%E4%BD%8D%E7%BD%AE">5.2.8 查看binlog位置</a></li>
</ul>
</li>
<li><a href="#53-mms_slave">5.3 mms_slave</a><ul>
<li><a href="#531-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">5.3.1 配置文件</a></li>
<li><a href="#532-%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1">5.3.2 启动服务</a></li>
<li><a href="#533-%E4%BF%AE%E6%94%B9%E5%88%9D%E5%A7%8B%E5%AF%86%E7%A0%81">5.3.3 修改初始密码</a></li>
<li><a href="#534-%E5%AE%A3%E5%91%8A%E4%B8%BB%E5%BA%93">5.3.4 宣告主库</a></li>
</ul>
</li>
<li><a href="#54-mms_mastera">5.4 mms_mastera</a><ul>
<li><a href="#541-%E5%AE%A3%E5%91%8A%E4%B8%BB%E5%BA%93">5.4.1 宣告主库</a></li>
<li><a href="#542-%E5%90%AF%E5%8A%A8%E4%BB%8E%E6%9C%8D%E5%8A%A1">5.4.2 启动从服务</a></li>
<li><a href="#543-%E6%9F%A5%E7%9C%8B%E4%BB%8E%E6%9C%8D%E5%8A%A1%E7%8A%B6%E6%80%81">5.4.3 查看从服务状态</a></li>
</ul>
</li>
<li><a href="#55-mms_slave">5.5 mms_slave</a><ul>
<li><a href="#552-%E5%90%AF%E5%8A%A8%E4%BB%8E%E6%9C%8D%E5%8A%A1">5.5.2 启动从服务</a></li>
<li><a href="#553-%E6%9F%A5%E7%9C%8B%E4%BB%8E%E6%9C%8D%E5%8A%A1%E7%8A%B6%E6%80%81">5.5.3 查看从服务状态</a></li>
</ul>
</li>
<li><a href="#56-%E9%AA%8C%E8%AF%81%E7%BB%93%E6%9E%9C">5.6 验证结果</a></li>
</ul>
</li>
<li><a href="#6-mycat%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E6%90%AD%E5%BB%BA">6 MyCAT数据库中间件的搭建</a><ul>
<li><a href="#61-%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85">6.1 软件安装</a></li>
<li><a href="#62-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">6.2 配置文件</a><ul>
<li><a href="#621-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%A6%82%E8%A7%88">6.2.1 配置文件概览</a></li>
<li><a href="#622-%E9%85%8D%E7%BD%AE%E7%9B%AE%E6%A0%87">6.2.2 配置目标</a><ul>
<li><a href="#6221-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8">6.2.2.1 分库分表</a></li>
<li><a href="#6222-%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB">6.2.2.2 读写分离</a></li>
<li><a href="#6223-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1">6.2.2.3 负载均衡</a></li>
<li><a href="#6224-%E8%87%AA%E5%8A%A8%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB">6.2.2.4 自动故障转移</a></li>
<li><a href="#6225-mycat%E8%BF%9E%E6%8E%A5mysql%E9%A9%B1%E5%8A%A8">6.2.2.5 mycat连接mysql驱动</a></li>
</ul>
</li>
<li><a href="#623-serverxml">6.2.3 server.xml</a></li>
<li><a href="#624-schemaxml">6.2.4 schema.xml</a></li>
<li><a href="#625-rulexml">6.2.5 rule.xml</a></li>
<li><a href="#626-autopartition-longtxt">6.2.6 autopartition-long.txt</a></li>
</ul>
</li>
<li><a href="#63-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E4%BE%8B">6.3 数据库实例</a><ul>
<li><a href="#631-%E6%B7%BB%E5%8A%A0%E5%AF%B9mycat%E7%9A%84%E6%8E%88%E6%9D%83">6.3.1 添加对mycat的授权</a></li>
<li><a href="#632-%E5%BB%BA%E5%BA%93%E5%BB%BA%E8%A1%A8">6.3.2 建库建表</a></li>
</ul>
</li>
<li><a href="#64-%E5%90%AF%E5%8A%A8mycat%E6%9C%8D%E5%8A%A1">6.4 启动mycat服务</a><ul>
<li><a href="#641-%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1">6.4.1 启动服务</a></li>
<li><a href="#642-%E6%9F%A5%E7%9C%8B%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B">6.4.2 查看守护进程</a></li>
<li><a href="#643-%E6%9F%A5%E7%9C%8B%E7%9B%91%E5%90%AC">6.4.3 查看监听</a></li>
</ul>
</li>
<li><a href="#65-%E9%AA%8C%E8%AF%81%E7%BB%93%E6%9E%9C">6.5 验证结果</a><ul>
<li><a href="#651-%E9%AA%8C%E8%AF%81mycat_01">6.5.1 验证mycat_01</a></li>
<li><a href="#652-%E9%AA%8C%E8%AF%81mycat_02">6.5.2 验证mycat_02</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#7-haproxy%E5%AE%9E%E7%8E%B0mycat%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1">7 HAproxy实现MyCat负载均衡</a><ul>
<li><a href="#71-%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85">7.1 软件安装</a></li>
<li><a href="#72-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">7.2 配置文件</a><ul>
<li><a href="#721-haproxy_01">7.2.1 haproxy_01</a></li>
<li><a href="#722-haproxy_02">7.2.2 haproxy_02</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#8-keepalived%E5%AE%9E%E7%8E%B0haproxy%E9%AB%98%E5%8F%AF%E7%94%A8">8 keepalived实现Haproxy高可用</a><ul>
<li><a href="#81-%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85">8.1 软件安装</a></li>
<li><a href="#82-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">8.2 配置文件</a><ul>
<li><a href="#821-keepalived_01">8.2.1 keepalived_01</a></li>
<li><a href="#822-keepalived_02">8.2.2 keepalived_02</a></li>
</ul>
</li>
<li><a href="#83-%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1">8.3 启动服务</a><ul>
<li><a href="#831-keepalived_01">8.3.1 keepalived_01</a></li>
<li><a href="#832-keepalived_02">8.3.2 keepalived_02</a></li>
</ul>
</li>
<li><a href="#84-%E9%AA%8C%E8%AF%81%E7%BB%93%E6%9E%9C">8.4 验证结果</a><ul>
<li><a href="#841-keepalived_01">8.4.1 keepalived_01</a></li>
<li><a href="#841-keepalived_02">8.4.1 keepalived_02</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#9-%E5%90%AF%E5%8A%A8haproxy">9 启动HAproxy</a><ul>
<li><a href="#91-%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1">9.1 启动服务</a></li>
<li><a href="#92-%E6%9F%A5%E7%9C%8B%E6%9C%8D%E5%8A%A1%E7%8A%B6%E6%80%81">9.2 查看服务状态</a></li>
<li><a href="#93-%E6%9F%A5%E7%9C%8Bhaproxy%E7%9B%91%E5%90%AC%E7%AB%AF%E5%8F%A3">9.3 查看haproxy监听端口</a></li>
</ul>
</li>
<li><a href="#10-%E6%B5%8B%E8%AF%95%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84">10 测试整体架构</a>  <ul>
<li><a href="#101-%E6%B5%8B%E8%AF%95%E5%88%86%E7%89%87">10.1 测试分片</a>  </li>
<li><a href="#1011-%E6%B5%8B%E8%AF%95%E6%80%9D%E8%B7%AF">10.1.1 测试思路</a>  </li>
<li><a href="#1012-%E6%B5%8B%E8%AF%95%E8%BF%87%E7%A8%8B">10.1.2 测试过程</a>  </li>
<li><a href="#1013-%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C">10.1.3 测试结果</a>  </li>
<li><a href="#10131-pxc">10.1.3.1 pxc</a>  </li>
<li><a href="#10132-mms">10.1.3.2 mms</a>  </li>
<li><a href="#102-%E6%B5%8B%E8%AF%95%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8ha">10.2 测试整体架构的高可用HA</a>  </li>
<li><a href="#1021-%E6%A8%A1%E6%8B%9F%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AE%BF%E9%97%AE">10.2.1 模拟客户端访问</a>  </li>
<li><a href="#1022-%E6%A8%A1%E6%8B%9Fhaproxy_01%E5%AE%95%E6%8E%89">10.2.2 模拟haproxy_01宕掉</a>  </li>
<li><a href="#1023-%E6%A8%A1%E6%8B%9Fmycat_01%E5%AE%95%E6%9C%BA">10.2.3 模拟mycat_01宕机</a>  </li>
<li><a href="#1024-%E6%A8%A1%E6%8B%9Fpxc_node1%E5%AE%95%E6%9C%BA">10.2.4 模拟pxc_node1宕机</a>  </li>
<li><a href="#103-%E6%80%BB%E7%BB%93">10.3 总结</a></li>
<li><a href="#%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3">参考文档</a></li>
</ul>
</li>
</ul>
<!-- /MDTOC -->

<h2 id="1-架构图" class="article-heading"><a href="#1-架构图" class="headerlink" title="1 架构图"></a>1 架构图<a class="article-anchor" href="#1-架构图" aria-hidden="true"></a></h2><p><img src="pic/%E5%9F%BA%E4%BA%8EMyCAT%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9E%B6%E6%9E%84.png"></p>
<ul>
<li>keepalived实现haproxy的高可用</li>
<li>haproxy实现mycat的负载均衡和高可用 <em>2台haproxy建议生产中和mycat服务分开 ，实验环境中由于虚拟机数量的限制，所以haproxy和mycat放在同一台上</em></li>
<li>mycat实现了数据库的读写分离、负载均衡、分库分表、自动故障转移</li>
<li>pxc集群实现了mysql高可用</li>
<li>mms双主多源复制实现mysql高可用</li>
</ul>
<p>整套架构最终实现数据库的分布式架构，单表数据量在两个数据节点都不够存放时，可以再添加一个mysql集群节点，mycat中做相应配置即可实现水平扩展。</p>
<h2 id="2-服务和节点规划" class="article-heading"><a href="#2-服务和节点规划" class="headerlink" title="2 服务和节点规划"></a>2 服务和节点规划<a class="article-anchor" href="#2-服务和节点规划" aria-hidden="true"></a></h2><p>一共准备了6台虚拟机操作系统 RHEL 7.2（CentOS 7.2），有条件的化，建议准备10台虚拟机。</p>
<table>
<thead>
<tr>
<th align="left">server</th>
<th align="left">port</th>
<th align="left">hostname</th>
<th align="left">ip</th>
</tr>
</thead>
<tbody><tr>
<td align="left">PXC node1</td>
<td align="left">3306</td>
<td align="left">mastera0</td>
<td align="left">172.25.0.11</td>
</tr>
<tr>
<td align="left">PXC node2</td>
<td align="left">3306</td>
<td align="left">masterb0</td>
<td align="left">172.25.0.12</td>
</tr>
<tr>
<td align="left">PXC node3</td>
<td align="left">3306</td>
<td align="left">slavea0</td>
<td align="left">172.25.0.13</td>
</tr>
<tr>
<td align="left">MMS mastera</td>
<td align="left">3306</td>
<td align="left">slaveb0</td>
<td align="left">172.25.0.14</td>
</tr>
<tr>
<td align="left">MMS masterb</td>
<td align="left">3306</td>
<td align="left">dbproxy0</td>
<td align="left">172.25.0.15</td>
</tr>
<tr>
<td align="left">MMS slave</td>
<td align="left">3306</td>
<td align="left">workstation0</td>
<td align="left">172.25.0.10</td>
</tr>
<tr>
<td align="left">mycat_node1</td>
<td align="left">8066</td>
<td align="left">dbproxy0</td>
<td align="left">172.25.0.15</td>
</tr>
<tr>
<td align="left">mycat_node2</td>
<td align="left">8066</td>
<td align="left">workstation0</td>
<td align="left">172.25.0.10</td>
</tr>
<tr>
<td align="left">haproxy_01</td>
<td align="left">7066</td>
<td align="left">dbproxy0</td>
<td align="left">172.25.0.15</td>
</tr>
<tr>
<td align="left">haproxy_02</td>
<td align="left">7066</td>
<td align="left">workstation0</td>
<td align="left">172.25.0.10</td>
</tr>
<tr>
<td align="left">keepalived_master</td>
<td align="left">vip:172.25.0.100</td>
<td align="left">dbproxy0</td>
<td align="left">172.25.0.15</td>
</tr>
<tr>
<td align="left">keepalived_backup</td>
<td align="left">vip:172.25.0.100</td>
<td align="left">workstation0</td>
<td align="left">172.25.0.10</td>
</tr>
</tbody></table>
<h2 id="3-软件准备" class="article-heading"><a href="#3-软件准备" class="headerlink" title="3 软件准备"></a>3 软件准备<a class="article-anchor" href="#3-软件准备" aria-hidden="true"></a></h2><ul>
<li><p>keepalived 使用系统自带yum源中的rpm包</p>
</li>
<li><p>haproxy 使用系统自带yum源中的rpm包</p>
</li>
<li><p>mycat 需要到mycat官网下载Mycat-server-1.5.1-RELEASE-20160328130228-linux.tar.gz 以及 oracle官网下载jdk-7u79-linux-x64.rpm 以及mysql官网下载mysql-connector-java-5.1.45.tar.gz</p>
</li>
<li><p>pxc和mms都使用percona公司的Percona-XtraDB-Cluster，在percona官网下载</p>
</li>
<li><p>innobackupex数据库物理备份工具在percona公司官网下载Percona-XtraBackup-2.3.4-re80c779-el7-x86_64-bundle.tar</p>
<p>下载后的包如下所示</p>
</li>
</ul>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mycat</span></span><br><span class="line">jdk-7u79-linux-x64.rpm</span><br><span class="line">Mycat-server-1.5.1-RELEASE-20160328130228-linux.tar.gz</span><br><span class="line">Mycat_V1.6.0.pdf</span><br><span class="line">mysql-connector-java-5.1.45.tar.gz</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">innobackupex</span></span><br><span class="line">libev-4.15-6.el7.x86_64.rpm</span><br><span class="line">percona-xtrabackup-24-2.4.8-1.el7.x86_64.rpm</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pxc</span></span><br><span class="line">Percona-XtraDB-Cluster-57-5.7.16-27.19.1.el7.x86_64.rpm</span><br><span class="line">Percona-XtraDB-Cluster-57-debuginfo-5.7.16-27.19.1.el7.x86_64.rpm</span><br><span class="line">Percona-XtraDB-Cluster-client-57-5.7.16-27.19.1.el7.x86_64.rpm</span><br><span class="line">Percona-XtraDB-Cluster-devel-57-5.7.16-27.19.1.el7.x86_64.rpm</span><br><span class="line">Percona-XtraDB-Cluster-full-57-5.7.16-27.19.1.el7.x86_64.rpm</span><br><span class="line">Percona-XtraDB-Cluster-garbd-57-5.7.16-27.19.1.el7.x86_64.rpm</span><br><span class="line">Percona-XtraDB-Cluster-server-57-5.7.16-27.19.1.el7.x86_64.rpm</span><br><span class="line">Percona-XtraDB-Cluster-shared-57-5.7.16-27.19.1.el7.x86_64.rpm</span><br><span class="line">Percona-XtraDB-Cluster-shared-compat-57-5.7.16-27.19.1.el7.x86_64.rpm</span><br><span class="line">Percona-XtraDB-Cluster-test-57-5.7.16-27.19.1.el7.x86_64.rpm</span><br><span class="line">galera-25.3.9-1.rhel7.el7.centos.x86_64.rpm</span><br><span class="line">jemalloc-3.6.0-1.el7.x86_64.rpm</span><br><span class="line">jemalloc-devel-3.6.0-1.el7.x86_64.rpm</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下面是自己通过createrepo命令生成的yum配置文件，若有疑问可以查一下【手动制作yum源】</span></span><br><span class="line">pxc.repo</span><br><span class="line">repodata</span><br></pre></td></tr></tbody></table></figure>

<h2 id="4-PXC集群的搭建" class="article-heading"><a href="#4-PXC集群的搭建" class="headerlink" title="4 PXC集群的搭建"></a>4 PXC集群的搭建<a class="article-anchor" href="#4-PXC集群的搭建" aria-hidden="true"></a></h2><p>percona xtradb cluster集群是基于引擎层的同步复制，所以数据一致性更高。</p>
<h3 id="4-1-安装软件" class="article-heading"><a href="#4-1-安装软件" class="headerlink" title="4.1 安装软件"></a>4.1 安装软件<a class="article-anchor" href="#4-1-安装软件" aria-hidden="true"></a></h3><p>auto_install_pxc.sh 脚本如下所示，需要在每一台pxc节点上安装。</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line">sed -i 's/SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config</span><br><span class="line">setenforce 0</span><br><span class="line">yum install -y wget net-tools vim</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此处是我自己搭建了一个局域网站实现pxc的局域网内的在线yum源</span></span><br><span class="line">wget http://172.25.254.254/content/Git/DB100_mysql/sides/soft/cluster/pxc-cluster-el7/pxc.repo -P /etc/yum.repos.d/</span><br><span class="line">yum clean all &amp;&amp; yum makecache</span><br><span class="line">for i in `rpm -qa|grep mariadb`;do rpm -e --nodeps $i;done</span><br><span class="line">yum install -y percona-xtrabackup-24 Percona-XtraDB-Cluster-57  galera* jemalloc*</span><br></pre></td></tr></tbody></table></figure>

<p>bash auto_install_pxc.sh</p>
<p>通过跳板机，远程操作多台机器，循环完成安装</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">for i in seq 10 15;do ssh-copy-id root@172.25.0.$i;done</span><br><span class="line">for i in seq 10 15;do scp auto_install_pxc.sh root@172.25.0.$i:~;done</span><br><span class="line">for i in seq 10 15;do ssh root@172.25.0.$i "bash auto_install_pxc.sh";done</span><br></pre></td></tr></tbody></table></figure>

<h3 id="4-2-pxc-node1" class="article-heading"><a href="#4-2-pxc-node1" class="headerlink" title="4.2 pxc_node1"></a>4.2 pxc_node1<a class="article-anchor" href="#4-2-pxc-node1" aria-hidden="true"></a></h3><h4 id="4-2-1-配置文件" class="article-heading"><a href="#4-2-1-配置文件" class="headerlink" title="4.2.1 配置文件"></a>4.2.1 配置文件<a class="article-anchor" href="#4-2-1-配置文件" aria-hidden="true"></a></h4><figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line"># vim /etc/my.cnf</span><br><span class="line">grep -v '^#\|^$' /etc/my.cnf</span><br><span class="line">[client]</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line">[mysqld]</span><br><span class="line">server-id=1 # server-id集群中每个节点保证唯一</span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line">log-error=/var/log/mysqld.log</span><br><span class="line">pid-file=/var/run/mysqld/mysqld.pid</span><br><span class="line">log-bin</span><br><span class="line">log_slave_updates</span><br><span class="line">expire_logs_days=7</span><br><span class="line">symbolic-links=0</span><br><span class="line">wsrep_provider=/usr/lib64/galera3/libgalera_smm.so</span><br><span class="line">wsrep_cluster_address=gcomm://  # 集群初始节点因此此处使用默认值即可</span><br><span class="line">binlog_format=ROW</span><br><span class="line">default_storage_engine=InnoDB</span><br><span class="line">wsrep_slave_threads= 8</span><br><span class="line">wsrep_log_conflicts</span><br><span class="line">innodb_autoinc_lock_mode=2</span><br><span class="line">wsrep_cluster_name=pxc-cluster # 集群的名称，集群中所有节点保持一致</span><br><span class="line">wsrep_node_name=pxc-cluster-node-1 # 集群节点的名称，自定义即可</span><br><span class="line">pxc_strict_mode=ENFORCING</span><br><span class="line">wsrep_sst_method=rsync # 集群间同步数据的方式</span><br></pre></td></tr></tbody></table></figure>

<h4 id="4-4-2-启动服务" class="article-heading"><a href="#4-4-2-启动服务" class="headerlink" title="4.4.2 启动服务"></a>4.4.2 启动服务<a class="article-anchor" href="#4-4-2-启动服务" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">systemctl start mysql</span><br></pre></td></tr></tbody></table></figure>

<h4 id="4-2-3-修改初始密码" class="article-heading"><a href="#4-2-3-修改初始密码" class="headerlink" title="4.2.3 修改初始密码"></a>4.2.3 修改初始密码<a class="article-anchor" href="#4-2-3-修改初始密码" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">password=`grep password /var/log/mysqld.log|awk '{print $11}'`</span><br><span class="line">mysqladmin -uroot -p$password password '(Uploo00king)'</span><br></pre></td></tr></tbody></table></figure>

<h5 id="4-2-3-1-密码修改失败处理" class="article-heading"><a href="#4-2-3-1-密码修改失败处理" class="headerlink" title="4.2.3.1 密码修改失败处理"></a>4.2.3.1 密码修改失败处理<a class="article-anchor" href="#4-2-3-1-密码修改失败处理" aria-hidden="true"></a></h5><p>有时初始密码中若包含？&amp; 很有可能不能修改成功，此时按照如下步骤即可</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改配置文件，跳过认证授权</span></span><br><span class="line">vim my.cf</span><br><span class="line">[mysqld]</span><br><span class="line">skip-grant-tables</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重新启动服务</span></span><br><span class="line">systemctl restart mysql</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">登陆数据库服务器后修改密码</span></span><br><span class="line">mysql &gt; update mysql.user set authentication_string=password('(Uploo00king)');</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改配置文件去除参数</span></span><br><span class="line">vim my.cf</span><br><span class="line">[mysqld]</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">skip-grant-tables</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启服务</span></span><br><span class="line">systemctl restart mysql</span><br></pre></td></tr></tbody></table></figure>

<h4 id="4-2-4-查看集群状态" class="article-heading"><a href="#4-2-4-查看集群状态" class="headerlink" title="4.2.4 查看集群状态"></a>4.2.4 查看集群状态<a class="article-anchor" href="#4-2-4-查看集群状态" aria-hidden="true"></a></h4><figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">mysql -uroot -p'(Uploo00king)' -e "show status like 'wsrep_cluster%'"</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+--------------------------+--------------------------------------+</span><br><span class="line">| Variable_name            | Value                                |</span><br><span class="line">+--------------------------+--------------------------------------+</span><br><span class="line">| wsrep_cluster_conf_id    | 1                                    |</span><br><span class="line">| wsrep_cluster_size       | 1                                    |</span><br><span class="line">| wsrep_cluster_state_uuid | 838b888e-0c95-11e8-9eaf-62dad1baf837 |</span><br><span class="line">| wsrep_cluster_status     | Primary                              |</span><br><span class="line">+--------------------------+--------------------------------------+</span><br></pre></td></tr></tbody></table></figure>

<h3 id="4-3-pxc-node2" class="article-heading"><a href="#4-3-pxc-node2" class="headerlink" title="4.3 pxc_node2"></a>4.3 pxc_node2<a class="article-anchor" href="#4-3-pxc-node2" aria-hidden="true"></a></h3><h4 id="4-3-1-配置文件" class="article-heading"><a href="#4-3-1-配置文件" class="headerlink" title="4.3.1 配置文件"></a>4.3.1 配置文件<a class="article-anchor" href="#4-3-1-配置文件" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">vim /etc/my.cnf</span><br><span class="line">grep -v '^#\|^$' /etc/my.cnf</span><br><span class="line">[client]</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line">[mysqld]</span><br><span class="line">server-id=2</span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line">log-error=/var/log/mysqld.log</span><br><span class="line">pid-file=/var/run/mysqld/mysqld.pid</span><br><span class="line">log-bin</span><br><span class="line">log_slave_updates</span><br><span class="line">expire_logs_days=7</span><br><span class="line">symbolic-links=0</span><br><span class="line">wsrep_provider=/usr/lib64/galera3/libgalera_smm.so</span><br><span class="line">wsrep_cluster_address="gcomm://172.25.0.11"</span><br><span class="line">binlog_format=ROW</span><br><span class="line">default_storage_engine=InnoDB</span><br><span class="line">wsrep_slave_threads= 8</span><br><span class="line">wsrep_log_conflicts</span><br><span class="line">innodb_autoinc_lock_mode=2</span><br><span class="line">wsrep_cluster_name=pxc-cluster</span><br><span class="line">wsrep_node_name=pxc-cluster-node-2</span><br><span class="line">pxc_strict_mode=ENFORCING</span><br><span class="line">wsrep_sst_method=rsync</span><br></pre></td></tr></tbody></table></figure>

<h4 id="4-3-2-启动服务" class="article-heading"><a href="#4-3-2-启动服务" class="headerlink" title="4.3.2 启动服务"></a>4.3.2 启动服务<a class="article-anchor" href="#4-3-2-启动服务" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">systemctl start mysql</span><br></pre></td></tr></tbody></table></figure>

<h4 id="4-3-3-修改初始密码" class="article-heading"><a href="#4-3-3-修改初始密码" class="headerlink" title="4.3.3 修改初始密码"></a>4.3.3 修改初始密码<a class="article-anchor" href="#4-3-3-修改初始密码" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">password=`grep password /var/log/mysqld.log|awk '{print $11}'`</span><br><span class="line">mysqladmin -uroot -p$password password '(Uploo00king)'</span><br></pre></td></tr></tbody></table></figure>

<h4 id="4-3-4-查看集群状态" class="article-heading"><a href="#4-3-4-查看集群状态" class="headerlink" title="4.3.4 查看集群状态"></a>4.3.4 查看集群状态<a class="article-anchor" href="#4-3-4-查看集群状态" aria-hidden="true"></a></h4><figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">mysql -uroot -p'(Uploo00king)' -e "show status like 'wsrep_cluster%'"</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+--------------------------+--------------------------------------+</span><br><span class="line">| Variable_name            | Value                                |</span><br><span class="line">+--------------------------+--------------------------------------+</span><br><span class="line">| wsrep_cluster_conf_id    | 2                                    |</span><br><span class="line">| wsrep_cluster_size       | 2                                    |</span><br><span class="line">| wsrep_cluster_state_uuid | 838b888e-0c95-11e8-9eaf-62dad1baf837 |</span><br><span class="line">| wsrep_cluster_status     | Primary                              |</span><br><span class="line">+--------------------------+--------------------------------------+</span><br></pre></td></tr></tbody></table></figure>

<h3 id="4-4-pxc-node3" class="article-heading"><a href="#4-4-pxc-node3" class="headerlink" title="4.4 pxc_node3"></a>4.4 pxc_node3<a class="article-anchor" href="#4-4-pxc-node3" aria-hidden="true"></a></h3><h4 id="4-4-1-配置文件" class="article-heading"><a href="#4-4-1-配置文件" class="headerlink" title="4.4.1 配置文件"></a>4.4.1 配置文件<a class="article-anchor" href="#4-4-1-配置文件" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">vim /etc/my.cnf</span><br><span class="line">grep -v '^#\|^$' /etc/my.cnf</span><br><span class="line">[client]</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line">[mysqld]</span><br><span class="line">server-id=3</span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line">log-error=/var/log/mysqld.log</span><br><span class="line">pid-file=/var/run/mysqld/mysqld.pid</span><br><span class="line">log-bin</span><br><span class="line">log_slave_updates</span><br><span class="line">expire_logs_days=7</span><br><span class="line">symbolic-links=0</span><br><span class="line">wsrep_provider=/usr/lib64/galera3/libgalera_smm.so</span><br><span class="line">wsrep_cluster_address="gcomm://172.25.0.11,172.25.0.12"</span><br><span class="line">binlog_format=ROW</span><br><span class="line">default_storage_engine=InnoDB</span><br><span class="line">wsrep_slave_threads= 8</span><br><span class="line">wsrep_log_conflicts</span><br><span class="line">innodb_autoinc_lock_mode=2</span><br><span class="line">wsrep_cluster_name=pxc-cluster</span><br><span class="line">wsrep_node_name=pxc-cluster-node-3</span><br><span class="line">pxc_strict_mode=ENFORCING</span><br><span class="line">wsrep_sst_method=rsync</span><br></pre></td></tr></tbody></table></figure>

<h4 id="4-4-2-启动服务-1" class="article-heading"><a href="#4-4-2-启动服务-1" class="headerlink" title="4.4.2 启动服务"></a>4.4.2 启动服务<a class="article-anchor" href="#4-4-2-启动服务-1" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">systemctl start mysql</span><br></pre></td></tr></tbody></table></figure>

<h4 id="4-4-3-修改初始密码" class="article-heading"><a href="#4-4-3-修改初始密码" class="headerlink" title="4.4.3 修改初始密码"></a>4.4.3 修改初始密码<a class="article-anchor" href="#4-4-3-修改初始密码" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">password=`grep password /var/log/mysqld.log|awk '{print $11}'`</span><br><span class="line">mysqladmin -uroot -p$password password '(Uploo00king)'</span><br></pre></td></tr></tbody></table></figure>

<h4 id="4-4-4-查看集群状态" class="article-heading"><a href="#4-4-4-查看集群状态" class="headerlink" title="4.4.4 查看集群状态"></a>4.4.4 查看集群状态<a class="article-anchor" href="#4-4-4-查看集群状态" aria-hidden="true"></a></h4><figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">mysql -uroot -p'(Uploo00king)' -e "show status like 'wsrep_cluster%'"</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+--------------------------+--------------------------------------+</span><br><span class="line">| Variable_name            | Value                                |</span><br><span class="line">+--------------------------+--------------------------------------+</span><br><span class="line">| wsrep_cluster_conf_id    | 3                                    |</span><br><span class="line">| wsrep_cluster_size       | 3                                    |</span><br><span class="line">| wsrep_cluster_state_uuid | 838b888e-0c95-11e8-9eaf-62dad1baf837 |</span><br><span class="line">| wsrep_cluster_status     | Primary                              |</span><br><span class="line">+--------------------------+--------------------------------------+</span><br></pre></td></tr></tbody></table></figure>

<h4 id="4-4-5-集群宕机后重启" class="article-heading"><a href="#4-4-5-集群宕机后重启" class="headerlink" title="4.4.5 集群宕机后重启"></a>4.4.5 集群宕机后重启<a class="article-anchor" href="#4-4-5-集群宕机后重启" aria-hidden="true"></a></h4><p>例如做实验的时候做到一半，就关机了，第二天再次启动虚拟机却发现集群无法启动了，执行一下步骤</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">systemctl stop mysql</span><br><span class="line">rm -rf /var/lib/mysql/grastate.dat</span><br><span class="line">systemctl start mysql</span><br></pre></td></tr></tbody></table></figure>

<p>grastate.dat文件中记录着集群的状态信息，例如集群唯一标识，重新启动集群节点前删除该文件即可。</p>
<h3 id="4-5-验证结果" class="article-heading"><a href="#4-5-验证结果" class="headerlink" title="4.5 验证结果"></a>4.5 验证结果<a class="article-anchor" href="#4-5-验证结果" aria-hidden="true"></a></h3><ol>
<li>从任意节点写入测试数据，所有节点都可以同步到</li>
<li>节点宕机后重新加入集群，可以自动同步增量数据</li>
</ol>
<p> </p>
<p> </p>
<h2 id="5-MMS高可用搭建" class="article-heading"><a href="#5-MMS高可用搭建" class="headerlink" title="5 MMS高可用搭建"></a>5 MMS高可用搭建<a class="article-anchor" href="#5-MMS高可用搭建" aria-hidden="true"></a></h2><p>MMS是通过mysql的replication技术实现了异步复制，双主+多源复制的高可用。</p>
<p>此处使用的还是pxc的mysql5.7版本</p>
<p><img src="pic/mms.png"></p>
<h3 id="5-1-mms-mastera" class="article-heading"><a href="#5-1-mms-mastera" class="headerlink" title="5.1 mms_mastera"></a>5.1 mms_mastera<a class="article-anchor" href="#5-1-mms-mastera" aria-hidden="true"></a></h3><h4 id="5-1-1-配置文件" class="article-heading"><a href="#5-1-1-配置文件" class="headerlink" title="5.1.1 配置文件"></a>5.1.1 配置文件<a class="article-anchor" href="#5-1-1-配置文件" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">vim /etc/my.cnf</span><br><span class="line">grep -v '^#\|^$' /etc/my.cnf</span><br><span class="line">[client]</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line">[mysqld]</span><br><span class="line">server-id=1 # 确保mms架构中id的唯一性</span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line">log-error=/var/log/mysqld.log</span><br><span class="line">pid-file=/var/run/mysqld/mysqld.pid</span><br><span class="line">log-bin</span><br><span class="line">log_slave_updates</span><br><span class="line">expire_logs_days=7</span><br><span class="line">symbolic-links=0</span><br><span class="line">wsrep_provider=/usr/lib64/galera3/libgalera_smm.so</span><br><span class="line">wsrep_cluster_address=gcomm://</span><br><span class="line">binlog_format=ROW</span><br><span class="line">default_storage_engine=InnoDB</span><br><span class="line">wsrep_slave_threads= 8</span><br><span class="line">wsrep_log_conflicts</span><br><span class="line">innodb_autoinc_lock_mode=2</span><br><span class="line">wsrep_cluster_name=mms-mastera # 由于此处使用集群版，就让每个主从节点都是一个独立的集群，每个节点取不同的名字即可</span><br><span class="line">wsrep_node_name=pxc-cluster-node-1</span><br><span class="line">pxc_strict_mode=ENFORCING</span><br><span class="line">wsrep_sst_method=rsync</span><br></pre></td></tr></tbody></table></figure>

<h4 id="5-1-2-启动服务" class="article-heading"><a href="#5-1-2-启动服务" class="headerlink" title="5.1.2 启动服务"></a>5.1.2 启动服务<a class="article-anchor" href="#5-1-2-启动服务" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">systemctl start mysql</span><br></pre></td></tr></tbody></table></figure>

<h4 id="5-1-3-修改初始密码" class="article-heading"><a href="#5-1-3-修改初始密码" class="headerlink" title="5.1.3 修改初始密码"></a>5.1.3 修改初始密码<a class="article-anchor" href="#5-1-3-修改初始密码" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">password=`grep password /var/log/mysqld.log|awk '{print $11}'`</span><br><span class="line">mysqladmin -uroot -p$password password '(Uploo00king)'</span><br></pre></td></tr></tbody></table></figure>

<h4 id="5-1-4-添加授权" class="article-heading"><a href="#5-1-4-添加授权" class="headerlink" title="5.1.4 添加授权"></a>5.1.4 添加授权<a class="article-anchor" href="#5-1-4-添加授权" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">mysql -uroot -p'(Uploo00king)' -e "grant all on *.* to slave@'%' identified by '(Uploo00king)';flush privileges"</span><br></pre></td></tr></tbody></table></figure>

<h4 id="5-1-5-查看binlog位置" class="article-heading"><a href="#5-1-5-查看binlog位置" class="headerlink" title="5.1.5 查看binlog位置"></a>5.1.5 查看binlog位置<a class="article-anchor" href="#5-1-5-查看binlog位置" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">mysql -uroot -p'(Uploo00king)' -e " show master status\G;"</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">             File: slaveb0-bin.000002</span><br><span class="line">         Position: 847</span><br><span class="line">     Binlog_Do_DB:</span><br><span class="line"> Binlog_Ignore_DB:</span><br><span class="line">Executed_Gtid_Set:</span><br></pre></td></tr></tbody></table></figure>

<h3 id="5-2-mms-masterb" class="article-heading"><a href="#5-2-mms-masterb" class="headerlink" title="5.2 mms_masterb"></a>5.2 mms_masterb<a class="article-anchor" href="#5-2-mms-masterb" aria-hidden="true"></a></h3><h4 id="5-2-1-配置文件" class="article-heading"><a href="#5-2-1-配置文件" class="headerlink" title="5.2.1 配置文件"></a>5.2.1 配置文件<a class="article-anchor" href="#5-2-1-配置文件" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">vim /etc/my.cnf</span><br><span class="line">grep -v '^#\|^$' /etc/my.cnf</span><br><span class="line">[client]</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line">[mysqld]</span><br><span class="line">server-id=2 # 确保mms架构中id的唯一性</span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line">log-error=/var/log/mysqld.log</span><br><span class="line">pid-file=/var/run/mysqld/mysqld.pid</span><br><span class="line">log-bin</span><br><span class="line">log_slave_updates</span><br><span class="line">expire_logs_days=7</span><br><span class="line">symbolic-links=0</span><br><span class="line">wsrep_provider=/usr/lib64/galera3/libgalera_smm.so</span><br><span class="line">wsrep_cluster_address=gcomm://</span><br><span class="line">binlog_format=ROW</span><br><span class="line">default_storage_engine=InnoDB</span><br><span class="line">wsrep_slave_threads= 8</span><br><span class="line">wsrep_log_conflicts</span><br><span class="line">innodb_autoinc_lock_mode=2</span><br><span class="line">wsrep_cluster_name=mms-masterb # 由于此处使用集群版，就让每个主从节点都是一个独立的集群，每个节点取不同的名字即可</span><br><span class="line">wsrep_node_name=pxc-cluster-node-1</span><br><span class="line">pxc_strict_mode=ENFORCING</span><br><span class="line">wsrep_sst_method=rsync</span><br></pre></td></tr></tbody></table></figure>

<h4 id="5-2-2-启动服务" class="article-heading"><a href="#5-2-2-启动服务" class="headerlink" title="5.2.2 启动服务"></a>5.2.2 启动服务<a class="article-anchor" href="#5-2-2-启动服务" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">systemctl start mysql</span><br></pre></td></tr></tbody></table></figure>

<h4 id="5-2-3-修改初始密码" class="article-heading"><a href="#5-2-3-修改初始密码" class="headerlink" title="5.2.3 修改初始密码"></a>5.2.3 修改初始密码<a class="article-anchor" href="#5-2-3-修改初始密码" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">password=`grep password /var/log/mysqld.log|awk '{print $11}'`</span><br><span class="line">mysqladmin -uroot -p$password password '(Uploo00king)'</span><br></pre></td></tr></tbody></table></figure>

<h4 id="5-2-4-添加授权" class="article-heading"><a href="#5-2-4-添加授权" class="headerlink" title="5.2.4 添加授权"></a>5.2.4 添加授权<a class="article-anchor" href="#5-2-4-添加授权" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">mysql -uroot -p'(Uploo00king)' -e "grant all on *.* to slave@'%' identified by '(Uploo00king)';flush privileges"</span><br></pre></td></tr></tbody></table></figure>

<h4 id="5-2-5-宣告主库" class="article-heading"><a href="#5-2-5-宣告主库" class="headerlink" title="5.2.5 宣告主库"></a>5.2.5 宣告主库<a class="article-anchor" href="#5-2-5-宣告主库" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">change master to master_host=<span class="string">'172.25.0.14'</span>,master_user=<span class="string">'slave'</span>,master_password=<span class="string">'(Uploo00king)'</span>,master_log_file=<span class="string">'slaveb0-bin.000002'</span>,master_log_pos=847;</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="5-2-6-启动从服务" class="article-heading"><a href="#5-2-6-启动从服务" class="headerlink" title="5.2.6 启动从服务"></a>5.2.6 启动从服务<a class="article-anchor" href="#5-2-6-启动从服务" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">start slave;</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="5-2-7-查看从服务状态" class="article-heading"><a href="#5-2-7-查看从服务状态" class="headerlink" title="5.2.7 查看从服务状态"></a>5.2.7 查看从服务状态<a class="article-anchor" href="#5-2-7-查看从服务状态" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">show slave status\G;</span></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 172.25.0.14</span><br><span class="line">                  Master_User: slave</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: slaveb0-bin.000002</span><br><span class="line">          Read_Master_Log_Pos: 847</span><br><span class="line">               Relay_Log_File: dbproxy0-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 322</span><br><span class="line">        Relay_Master_Log_File: slaveb0-bin.000002</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB:</span><br><span class="line">           Replicate_Do_Table:</span><br><span class="line">       Replicate_Ignore_Table:</span><br><span class="line">      Replicate_Wild_Do_Table:</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error:</span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 847</span><br><span class="line">              Relay_Log_Space: 532</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File:</span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File:</span><br><span class="line">           Master_SSL_CA_Path:</span><br><span class="line">              Master_SSL_Cert:</span><br><span class="line">            Master_SSL_Cipher:</span><br><span class="line">               Master_SSL_Key:</span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error:</span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error:</span><br><span class="line">  Replicate_Ignore_Server_Ids:</span><br><span class="line">             Master_Server_Id: 1</span><br><span class="line">                  Master_UUID: fa24bb7f-0c99-11e8-a8fa-52540000000e</span><br><span class="line">             Master_Info_File: /var/lib/mysql/master.info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind:</span><br><span class="line">      Last_IO_Error_Timestamp:</span><br><span class="line">     Last_SQL_Error_Timestamp:</span><br><span class="line">               Master_SSL_Crl:</span><br><span class="line">           Master_SSL_Crlpath:</span><br><span class="line">           Retrieved_Gtid_Set:</span><br><span class="line">            Executed_Gtid_Set:</span><br><span class="line">                Auto_Position: 0</span><br><span class="line">         Replicate_Rewrite_DB:</span><br><span class="line">                 Channel_Name:</span><br><span class="line">           Master_TLS_Version:</span><br></pre></td></tr></tbody></table></figure>

<h4 id="5-2-8-查看binlog位置" class="article-heading"><a href="#5-2-8-查看binlog位置" class="headerlink" title="5.2.8 查看binlog位置"></a>5.2.8 查看binlog位置<a class="article-anchor" href="#5-2-8-查看binlog位置" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">mysql -uroot -p'(Uploo00king)' -e " show master status\G;"</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">             File: dbproxy0-bin.000002</span><br><span class="line">         Position: 847</span><br><span class="line">     Binlog_Do_DB:</span><br><span class="line"> Binlog_Ignore_DB:</span><br><span class="line">Executed_Gtid_Set:</span><br></pre></td></tr></tbody></table></figure>

<h3 id="5-3-mms-slave" class="article-heading"><a href="#5-3-mms-slave" class="headerlink" title="5.3 mms_slave"></a>5.3 mms_slave<a class="article-anchor" href="#5-3-mms-slave" aria-hidden="true"></a></h3><p>这台mysql实例将配置两个主库，叫做多源复制，该技术从mysql5.7版本才有，需要在从库上添加两个参数</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">master-info-repository=table	# 开启多源复制需要将主库信息以表格的方式存放</span><br><span class="line">relay-log-info-repository=table # 开启多源复制需要将中继日志信息以表格方式存放</span><br></pre></td></tr></tbody></table></figure>

<h4 id="5-3-1-配置文件" class="article-heading"><a href="#5-3-1-配置文件" class="headerlink" title="5.3.1 配置文件"></a>5.3.1 配置文件<a class="article-anchor" href="#5-3-1-配置文件" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">vim /etc/my.cnf</span><br><span class="line">grep -v '^#\|^$' /etc/my.cnf</span><br><span class="line">[client]</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line">[mysqld]</span><br><span class="line">server-id=3</span><br><span class="line">master-info-repository=table	# 开启多源复制需要将主库信息以表格的方式存放</span><br><span class="line">relay-log-info-repository=table # 开启多源复制需要将中继日志信息以表格方式存放</span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line">log-error=/var/log/mysqld.log</span><br><span class="line">pid-file=/var/run/mysqld/mysqld.pid</span><br><span class="line">log-bin</span><br><span class="line">log_slave_updates</span><br><span class="line">expire_logs_days=7</span><br><span class="line">symbolic-links=0</span><br><span class="line">wsrep_provider=/usr/lib64/galera3/libgalera_smm.so</span><br><span class="line">wsrep_cluster_address=gcomm://</span><br><span class="line">binlog_format=ROW</span><br><span class="line">default_storage_engine=InnoDB</span><br><span class="line">wsrep_slave_threads= 8</span><br><span class="line">wsrep_log_conflicts</span><br><span class="line">innodb_autoinc_lock_mode=2</span><br><span class="line">wsrep_cluster_name=mms-slave</span><br><span class="line">wsrep_node_name=pxc-cluster-node-1</span><br><span class="line">pxc_strict_mode=ENFORCING</span><br><span class="line">wsrep_sst_method=rsync</span><br></pre></td></tr></tbody></table></figure>

<h4 id="5-3-2-启动服务" class="article-heading"><a href="#5-3-2-启动服务" class="headerlink" title="5.3.2 启动服务"></a>5.3.2 启动服务<a class="article-anchor" href="#5-3-2-启动服务" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">systemctl start mysql</span><br></pre></td></tr></tbody></table></figure>

<h4 id="5-3-3-修改初始密码" class="article-heading"><a href="#5-3-3-修改初始密码" class="headerlink" title="5.3.3 修改初始密码"></a>5.3.3 修改初始密码<a class="article-anchor" href="#5-3-3-修改初始密码" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">password=`grep password /var/log/mysqld.log|awk '{print $11}'`</span><br><span class="line">mysqladmin -uroot -p$password password '(Uploo00king)'</span><br></pre></td></tr></tbody></table></figure>

<h4 id="5-3-4-宣告主库" class="article-heading"><a href="#5-3-4-宣告主库" class="headerlink" title="5.3.4 宣告主库"></a>5.3.4 宣告主库<a class="article-anchor" href="#5-3-4-宣告主库" aria-hidden="true"></a></h4><p>先配置mastera为主，稍后会再配置masterb</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">change master to master_host=<span class="string">'172.25.0.14'</span>,master_user=<span class="string">'slave'</span>,master_password=<span class="string">'(Uploo00king)'</span>,master_log_file=<span class="string">'slaveb0-bin.000002'</span>,master_log_pos=847 <span class="keyword">for</span> channel <span class="string">"channela"</span>;</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="5-4-mms-mastera" class="article-heading"><a href="#5-4-mms-mastera" class="headerlink" title="5.4 mms_mastera"></a>5.4 mms_mastera<a class="article-anchor" href="#5-4-mms-mastera" aria-hidden="true"></a></h3><p>配置mms_masterb为mms_mastera的主</p>
<h4 id="5-4-1-宣告主库" class="article-heading"><a href="#5-4-1-宣告主库" class="headerlink" title="5.4.1 宣告主库"></a>5.4.1 宣告主库<a class="article-anchor" href="#5-4-1-宣告主库" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">mysql &gt; change master to master_host='172.25.0.15',master_user='slave',master_password='(Uploo00king)',master_log_file='dbproxy0-bin.000002',master_log_pos=847;</span><br></pre></td></tr></tbody></table></figure>

<h4 id="5-4-2-启动从服务" class="article-heading"><a href="#5-4-2-启动从服务" class="headerlink" title="5.4.2 启动从服务"></a>5.4.2 启动从服务<a class="article-anchor" href="#5-4-2-启动从服务" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">start slave;</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="5-4-3-查看从服务状态" class="article-heading"><a href="#5-4-3-查看从服务状态" class="headerlink" title="5.4.3 查看从服务状态"></a>5.4.3 查看从服务状态<a class="article-anchor" href="#5-4-3-查看从服务状态" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">show slave status\G;</span></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 172.25.0.15</span><br><span class="line">                  Master_User: slave</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: dbproxy0-bin.000002</span><br><span class="line">          Read_Master_Log_Pos: 847</span><br><span class="line">               Relay_Log_File: slaveb0-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 323</span><br><span class="line">        Relay_Master_Log_File: dbproxy0-bin.000002</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB:</span><br><span class="line">           Replicate_Do_Table:</span><br><span class="line">       Replicate_Ignore_Table:</span><br><span class="line">      Replicate_Wild_Do_Table:</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error:</span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 847</span><br><span class="line">              Relay_Log_Space: 532</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File:</span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File:</span><br><span class="line">           Master_SSL_CA_Path:</span><br><span class="line">              Master_SSL_Cert:</span><br><span class="line">            Master_SSL_Cipher:</span><br><span class="line">               Master_SSL_Key:</span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error:</span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error:</span><br><span class="line">  Replicate_Ignore_Server_Ids:</span><br><span class="line">             Master_Server_Id: 2</span><br><span class="line">                  Master_UUID: 669832f0-0c9b-11e8-b46e-52540000000f</span><br><span class="line">             Master_Info_File: /var/lib/mysql/master.info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind:</span><br><span class="line">      Last_IO_Error_Timestamp:</span><br><span class="line">     Last_SQL_Error_Timestamp:</span><br><span class="line">               Master_SSL_Crl:</span><br><span class="line">           Master_SSL_Crlpath:</span><br><span class="line">           Retrieved_Gtid_Set:</span><br><span class="line">            Executed_Gtid_Set:</span><br><span class="line">                Auto_Position: 0</span><br><span class="line">         Replicate_Rewrite_DB:</span><br><span class="line">                 Channel_Name:</span><br><span class="line">           Master_TLS_Version:</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></tbody></table></figure>

<h3 id="5-5-mms-slave" class="article-heading"><a href="#5-5-mms-slave" class="headerlink" title="5.5 mms_slave"></a>5.5 mms_slave<a class="article-anchor" href="#5-5-mms-slave" aria-hidden="true"></a></h3><p>配置mms_masterb成为mms_slave的第二个主</p>
<p>####5.5.1 宣告主库</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">mysql &gt; change master to master_host='172.25.0.15',master_user='slave',master_password='(Uploo00king)',master_log_file='dbproxy0-bin.000002',master_log_pos=847 for channel "channelb";</span><br></pre></td></tr></tbody></table></figure>

<h4 id="5-5-2-启动从服务" class="article-heading"><a href="#5-5-2-启动从服务" class="headerlink" title="5.5.2 启动从服务"></a>5.5.2 启动从服务<a class="article-anchor" href="#5-5-2-启动从服务" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">start slave;</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="5-5-3-查看从服务状态" class="article-heading"><a href="#5-5-3-查看从服务状态" class="headerlink" title="5.5.3 查看从服务状态"></a>5.5.3 查看从服务状态<a class="article-anchor" href="#5-5-3-查看从服务状态" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">show slave status\G;</span></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 172.25.0.14</span><br><span class="line">                  Master_User: slave</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: slaveb0-bin.000002</span><br><span class="line">          Read_Master_Log_Pos: 847</span><br><span class="line">               Relay_Log_File: workstation0-relay-bin-channela.000002</span><br><span class="line">                Relay_Log_Pos: 322</span><br><span class="line">        Relay_Master_Log_File: slaveb0-bin.000002</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB:</span><br><span class="line">           Replicate_Do_Table:</span><br><span class="line">       Replicate_Ignore_Table:</span><br><span class="line">      Replicate_Wild_Do_Table:</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error:</span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 847</span><br><span class="line">              Relay_Log_Space: 545</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File:</span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File:</span><br><span class="line">           Master_SSL_CA_Path:</span><br><span class="line">              Master_SSL_Cert:</span><br><span class="line">            Master_SSL_Cipher:</span><br><span class="line">               Master_SSL_Key:</span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error:</span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error:</span><br><span class="line">  Replicate_Ignore_Server_Ids:</span><br><span class="line">             Master_Server_Id: 1</span><br><span class="line">                  Master_UUID: fa24bb7f-0c99-11e8-a8fa-52540000000e</span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind:</span><br><span class="line">      Last_IO_Error_Timestamp:</span><br><span class="line">     Last_SQL_Error_Timestamp:</span><br><span class="line">               Master_SSL_Crl:</span><br><span class="line">           Master_SSL_Crlpath:</span><br><span class="line">           Retrieved_Gtid_Set:</span><br><span class="line">            Executed_Gtid_Set:</span><br><span class="line">                Auto_Position: 0</span><br><span class="line">         Replicate_Rewrite_DB:</span><br><span class="line">                 Channel_Name: channela</span><br><span class="line">           Master_TLS_Version:</span><br><span class="line">*************************** 2. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 172.25.0.15</span><br><span class="line">                  Master_User: slave</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: dbproxy0-bin.000002</span><br><span class="line">          Read_Master_Log_Pos: 847</span><br><span class="line">               Relay_Log_File: workstation0-relay-bin-channelb.000002</span><br><span class="line">                Relay_Log_Pos: 323</span><br><span class="line">        Relay_Master_Log_File: dbproxy0-bin.000002</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB:</span><br><span class="line">           Replicate_Do_Table:</span><br><span class="line">       Replicate_Ignore_Table:</span><br><span class="line">      Replicate_Wild_Do_Table:</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error:</span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 847</span><br><span class="line">              Relay_Log_Space: 546</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File:</span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File:</span><br><span class="line">           Master_SSL_CA_Path:</span><br><span class="line">              Master_SSL_Cert:</span><br><span class="line">            Master_SSL_Cipher:</span><br><span class="line">               Master_SSL_Key:</span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error:</span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error:</span><br><span class="line">  Replicate_Ignore_Server_Ids:</span><br><span class="line">             Master_Server_Id: 2</span><br><span class="line">                  Master_UUID: 669832f0-0c9b-11e8-b46e-52540000000f</span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind:</span><br><span class="line">      Last_IO_Error_Timestamp:</span><br><span class="line">     Last_SQL_Error_Timestamp:</span><br><span class="line">               Master_SSL_Crl:</span><br><span class="line">           Master_SSL_Crlpath:</span><br><span class="line">           Retrieved_Gtid_Set:</span><br><span class="line">            Executed_Gtid_Set:</span><br><span class="line">                Auto_Position: 0</span><br><span class="line">         Replicate_Rewrite_DB:</span><br><span class="line">                 Channel_Name: channelb</span><br><span class="line">           Master_TLS_Version:</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></tbody></table></figure>

<h3 id="5-6-验证结果" class="article-heading"><a href="#5-6-验证结果" class="headerlink" title="5.6 验证结果"></a>5.6 验证结果<a class="article-anchor" href="#5-6-验证结果" aria-hidden="true"></a></h3><ol>
<li>从主节点写入测试数据，所有节点都可以同步到</li>
<li>从节点既能同步mastera的数据，也能同步masterb的数据</li>
<li>主节点任意一个宕机后，重新加入需要从节点重启slave服务</li>
<li>从节点宕机后，重新加入即可自动同步数据</li>
</ol>
<p> </p>
<p> </p>
<h2 id="6-MyCAT数据库中间件的搭建" class="article-heading"><a href="#6-MyCAT数据库中间件的搭建" class="headerlink" title="6 MyCAT数据库中间件的搭建"></a>6 MyCAT数据库中间件的搭建<a class="article-anchor" href="#6-MyCAT数据库中间件的搭建" aria-hidden="true"></a></h2><p>MyCAT前身是阿里巴巴的cobar，目前是国内高并发高性能的开源中间件。</p>
<p>在该架构中担负着数据库读写分离、负载均衡、分库分表、自动故障转移的重要角色。</p>
<h3 id="6-1-软件安装" class="article-heading"><a href="#6-1-软件安装" class="headerlink" title="6.1 软件安装"></a>6.1 软件安装<a class="article-anchor" href="#6-1-软件安装" aria-hidden="true"></a></h3><p>准备auto_install_mycat.sh安装脚本，分别在mycat_01和mycat_02上完成安装。</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">mkdir /alidata/install -p</span><br><span class="line">mkdir /alidata/mycat</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">软件的连接我用的自己局域网的rpm包，你需要自己找资源下载</span></span><br><span class="line">wget http://172.25.254.254/content/Git/DB100_mysql/sides/soft/pxcmycat/jdk-7u79-linux-x64.rpm -P /alidata/install</span><br><span class="line">wget http://172.25.254.254/content/Git/DB100_mysql/sides/soft/pxcmycat/Mycat-server-1.5.1-RELEASE-20160328130228-linux.tar.gz -P /alidata/install</span><br><span class="line">wget http://172.25.254.254/content/Git/DB100_mysql/sides/soft/pxcmycat/mysql-connector-java-5.1.45.tar.gz -P /alidata/install</span><br><span class="line">cd /alidata/install</span><br><span class="line">rpm -ivh jdk-7u79-linux-x64.rpm</span><br><span class="line">tar -xf Mycat-server-1.5.1-RELEASE-20160328130228-linux.tar.gz</span><br><span class="line">mv mycat /alidata/</span><br><span class="line">tar -xf mysql-connector-java-5.1.45.tar.gz</span><br><span class="line">cp mysql-connector-java-5.1.45/mysql-connector-java-5.1.45-bin.jar /alidata/mycat/lib</span><br><span class="line">chmod a+x /alidata/mycat/lib/mysql-connector-java-5.1.45-bin.jar</span><br><span class="line">cat &gt;&gt; /etc/bashrc &lt;&lt; ENDF</span><br><span class="line">export JAVA_HOME=/usr/java/jdk1.7.0_79/</span><br><span class="line">export PATH=\$PATH:/alidata/mycat/bin</span><br><span class="line">ENDF</span><br><span class="line">source /etc/bashrc</span><br></pre></td></tr></tbody></table></figure>

<p>bash auto_install_mycat.sh</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">for i in `seq 10 15`;do scp auto_install_mycat.sh root@172.25.0.$i:~;done</span><br><span class="line">for i in `seq 10 15`;do ssh root@172.25.0.$i "bash auto_install_mycat.sh";done</span><br></pre></td></tr></tbody></table></figure>

<p>注意：java的路径需要在bash的启动配置中宣告</p>
<h3 id="6-2-配置文件" class="article-heading"><a href="#6-2-配置文件" class="headerlink" title="6.2 配置文件"></a>6.2 配置文件<a class="article-anchor" href="#6-2-配置文件" aria-hidden="true"></a></h3><h4 id="6-2-1-配置文件概览" class="article-heading"><a href="#6-2-1-配置文件概览" class="headerlink" title="6.2.1 配置文件概览"></a>6.2.1 配置文件概览<a class="article-anchor" href="#6-2-1-配置文件概览" aria-hidden="true"></a></h4><table>
<thead>
<tr>
<th>文件名</th>
<th>文件简介</th>
</tr>
</thead>
<tbody><tr>
<td>server.xml</td>
<td>mycat的认证权限、服务监听等配置</td>
</tr>
<tr>
<td>schema.xml</td>
<td>mycat逻辑库对应的数据库节点配置（负载均衡、读写分离、分库分表、自动故障转移等）</td>
</tr>
<tr>
<td>rule.xml</td>
<td>mycat分库分表的算法</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="6-2-2-配置目标" class="article-heading"><a href="#6-2-2-配置目标" class="headerlink" title="6.2.2 配置目标"></a>6.2.2 配置目标<a class="article-anchor" href="#6-2-2-配置目标" aria-hidden="true"></a></h4><h5 id="6-2-2-1-分库分表" class="article-heading"><a href="#6-2-2-1-分库分表" class="headerlink" title="6.2.2.1 分库分表"></a>6.2.2.1 分库分表<a class="article-anchor" href="#6-2-2-1-分库分表" aria-hidden="true"></a></h5><ul>
<li>ecshop库中的t2表一共分了16个库</li>
<li>16个库对应16个datanode数据节点</li>
<li>每个节点有对应的后端数据库实例的库名</li>
<li>后端有两个高可用架构pxc和mms组成</li>
<li>每个高可用架构提供db2_01~db2_08一共8个库</li>
</ul>
<h5 id="6-2-2-2-读写分离" class="article-heading"><a href="#6-2-2-2-读写分离" class="headerlink" title="6.2.2.2 读写分离"></a>6.2.2.2 读写分离<a class="article-anchor" href="#6-2-2-2-读写分离" aria-hidden="true"></a></h5><ul>
<li>pxc读写分离机制为：node1写，node2和node3读</li>
<li>mms读写分离机制为：mastera写，masterb和slave读</li>
</ul>
<h5 id="6-2-2-3-负载均衡" class="article-heading"><a href="#6-2-2-3-负载均衡" class="headerlink" title="6.2.2.3 负载均衡"></a>6.2.2.3 负载均衡<a class="article-anchor" href="#6-2-2-3-负载均衡" aria-hidden="true"></a></h5><ul>
<li>pxc：读请求随机分配给node2和node3</li>
<li>mms：读请求随机分配给masterb和slave读</li>
</ul>
<h5 id="6-2-2-4-自动故障转移" class="article-heading"><a href="#6-2-2-4-自动故障转移" class="headerlink" title="6.2.2.4 自动故障转移"></a>6.2.2.4 自动故障转移<a class="article-anchor" href="#6-2-2-4-自动故障转移" aria-hidden="true"></a></h5><ul>
<li>pxc的心跳检测<code>show status like 'wsrep%'</code></li>
<li>mms的心跳检测<code>select user()</code></li>
</ul>
<h5 id="6-2-2-5-mycat连接mysql驱动" class="article-heading"><a href="#6-2-2-5-mycat连接mysql驱动" class="headerlink" title="6.2.2.5 mycat连接mysql驱动"></a>6.2.2.5 mycat连接mysql驱动<a class="article-anchor" href="#6-2-2-5-mycat连接mysql驱动" aria-hidden="true"></a></h5><ul>
<li>mycat连接pxc使用的驱动为：<code>native</code></li>
<li>mycat连接mms使用驱动为：<code>jdbc</code></li>
</ul>
<h4 id="6-2-3-server-xml" class="article-heading"><a href="#6-2-3-server-xml" class="headerlink" title="6.2.3 server.xml"></a>6.2.3 server.xml<a class="article-anchor" href="#6-2-3-server-xml" aria-hidden="true"></a></h4><ol>
<li>用户名和密码 root/uplooking</li>
<li>逻辑库名 ecshop</li>
<li>数据监听端口 8066</li>
<li>管理监听端口 9066</li>
</ol>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line">&lt;!-- - - Licensed under the Apache License, Version 2.0 (the "License");</span><br><span class="line">	- you may not use this file except in compliance with the License. - You</span><br><span class="line">	may obtain a copy of the License at - - http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="line">	- - Unless required by applicable law or agreed to in writing, software -</span><br><span class="line">	distributed under the License is distributed on an "AS IS" BASIS, - WITHOUT</span><br><span class="line">	WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. - See the</span><br><span class="line">	License for the specific language governing permissions and - limitations</span><br><span class="line">	under the License. --&gt;</span><br><span class="line">&lt;!DOCTYPE mycat:server SYSTEM "server.dtd"&gt;</span><br><span class="line">&lt;mycat:server xmlns:mycat="http://org.opencloudb/"&gt;</span><br><span class="line">	&lt;system&gt;</span><br><span class="line">	&lt;property name="defaultSqlParser"&gt;druidparser&lt;/property&gt;</span><br><span class="line">	&lt;property name="serverPort"&gt;8066&lt;/property&gt; &lt;property name="managerPort"&gt;9066&lt;/property&gt;</span><br><span class="line">      &lt;!--  &lt;property name="useCompression"&gt;1&lt;/property&gt;--&gt; &lt;!--1为开启mysql压缩协议--&gt;</span><br><span class="line">	&lt;!-- &lt;property name="processorBufferChunk"&gt;40960&lt;/property&gt; --&gt;</span><br><span class="line">	&lt;!--</span><br><span class="line">	&lt;property name="processors"&gt;1&lt;/property&gt;</span><br><span class="line">	&lt;property name="processorExecutor"&gt;32&lt;/property&gt;</span><br><span class="line"><span class="meta prompt_">	 --&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">		&lt;!--默认是65535 64K 用于sql解析时最大文本长度 --&gt;</span></span><br><span class="line">		&lt;!--&lt;property name="maxStringLiteralLength"&gt;65535&lt;/property&gt;--&gt;</span><br><span class="line">		&lt;!--&lt;property name="sequnceHandlerType"&gt;0&lt;/property&gt;--&gt;</span><br><span class="line">		&lt;!--&lt;property name="backSocketNoDelay"&gt;1&lt;/property&gt;--&gt;</span><br><span class="line">		&lt;!--&lt;property name="frontSocketNoDelay"&gt;1&lt;/property&gt;--&gt;</span><br><span class="line">		&lt;!--&lt;property name="processorExecutor"&gt;16&lt;/property&gt;--&gt;</span><br><span class="line">		&lt;!--</span><br><span class="line">			&lt;property name="mutiNodeLimitType"&gt;1&lt;/property&gt; 0：开启小数量级（默认） ；1：开启亿级数据排序</span><br><span class="line">	    	&lt;property name="mutiNodePatchSize"&gt;100&lt;/property&gt; 亿级数量排序批量</span><br><span class="line">			&lt;property name="processors"&gt;32&lt;/property&gt; &lt;property name="processorExecutor"&gt;32&lt;/property&gt;</span><br><span class="line">			&lt;property name="idleTimeout"&gt;300000&lt;/property&gt; &lt;property name="bindIp"&gt;0.0.0.0&lt;/property&gt;</span><br><span class="line">			&lt;property name="frontWriteQueueSize"&gt;4096&lt;/property&gt; &lt;property name="processors"&gt;32&lt;/property&gt; --&gt;</span><br><span class="line">	&lt;/system&gt;</span><br><span class="line">	&lt;user name="root"&gt;</span><br><span class="line">		&lt;property name="password"&gt;uplooking&lt;/property&gt;</span><br><span class="line">		&lt;property name="schemas"&gt;ecshop&lt;/property&gt;</span><br><span class="line">	&lt;/user&gt;</span><br><span class="line"></span><br><span class="line">	&lt;user name="user"&gt;</span><br><span class="line">		&lt;property name="password"&gt;user&lt;/property&gt;</span><br><span class="line">		&lt;property name="schemas"&gt;ecshop&lt;/property&gt;</span><br><span class="line">		&lt;property name="readOnly"&gt;true&lt;/property&gt;</span><br><span class="line">	&lt;/user&gt;</span><br><span class="line">	&lt;!--</span><br><span class="line">	&lt;quarantine&gt;</span><br><span class="line">	   &lt;whitehost&gt;</span><br><span class="line">	      &lt;host host="127.0.0.1" user="mycat"/&gt;</span><br><span class="line">	      &lt;host host="127.0.0.2" user="mycat"/&gt;</span><br><span class="line">	   &lt;/whitehost&gt;</span><br><span class="line">       &lt;blacklist check="false"&gt;&lt;/blacklist&gt;</span><br><span class="line">	&lt;/quarantine&gt;</span><br><span class="line"><span class="meta prompt_">	--&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"></span></span><br><span class="line">&lt;/mycat:server&gt;</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h4 id="6-2-4-schema-xml" class="article-heading"><a href="#6-2-4-schema-xml" class="headerlink" title="6.2.4 schema.xml"></a>6.2.4 schema.xml<a class="article-anchor" href="#6-2-4-schema-xml" aria-hidden="true"></a></h4><p>逻辑库ecshop的物理节点配置明细：</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">&lt;?xml version="1.0"?&gt;</span><br><span class="line">&lt;!DOCTYPE mycat:schema SYSTEM "schema.dtd"&gt;</span><br><span class="line">&lt;mycat:schema xmlns:mycat="http://org.opencloudb/"&gt;</span><br><span class="line"></span><br><span class="line">	&lt;schema name="ecshop" checkSQLschema="false" sqlMaxLimit="100"&gt;</span><br><span class="line">		&lt;table name='t2' primaryKey='id' dataNode="dn1,dn2,dn3,dn4,dn5,dn6,dn7,dn8,dn9,dn10,dn11,dn12,dn13,dn14,dn15,dn16" rule='auto-sharding-long'/&gt;</span><br><span class="line">	&lt;/schema&gt;</span><br><span class="line">	&lt;dataNode name="dn1" dataHost="pxc-cluster-1" database="db2_01" /&gt;</span><br><span class="line">	&lt;dataNode name="dn2" dataHost="pxc-cluster-1" database="db2_02" /&gt;</span><br><span class="line">	&lt;dataNode name="dn3" dataHost="pxc-cluster-1" database="db2_03" /&gt;</span><br><span class="line">	&lt;dataNode name="dn4" dataHost="pxc-cluster-1" database="db2_04" /&gt;</span><br><span class="line">	&lt;dataNode name="dn5" dataHost="pxc-cluster-1" database="db2_05" /&gt;</span><br><span class="line">	&lt;dataNode name="dn6" dataHost="pxc-cluster-1" database="db2_06" /&gt;</span><br><span class="line">	&lt;dataNode name="dn7" dataHost="pxc-cluster-1" database="db2_07" /&gt;</span><br><span class="line">	&lt;dataNode name="dn8" dataHost="pxc-cluster-1" database="db2_08" /&gt;</span><br><span class="line">	&lt;dataNode name="dn9" dataHost="mms" database="db2_01" /&gt;</span><br><span class="line">	&lt;dataNode name="dn10" dataHost="mms" database="db2_02" /&gt;</span><br><span class="line">	&lt;dataNode name="dn11" dataHost="mms" database="db2_03" /&gt;</span><br><span class="line">	&lt;dataNode name="dn12" dataHost="mms" database="db2_04" /&gt;</span><br><span class="line">	&lt;dataNode name="dn13" dataHost="mms" database="db2_05" /&gt;</span><br><span class="line">	&lt;dataNode name="dn14" dataHost="mms" database="db2_06" /&gt;</span><br><span class="line">	&lt;dataNode name="dn15" dataHost="mms" database="db2_07" /&gt;</span><br><span class="line">	&lt;dataNode name="dn16" dataHost="mms" database="db2_08" /&gt;</span><br><span class="line">	&lt;dataHost name="pxc-cluster-1" maxCon="1000" minCon="10" balance="1"</span><br><span class="line">		writeType="0" dbType="mysql" dbDriver="native" switchType="3"  slaveThreshold="100"&gt;</span><br><span class="line">		&lt;heartbeat&gt;show status like 'wsrep%'&lt;/heartbeat&gt;</span><br><span class="line">		&lt;writeHost host="mastera0" url="172.25.0.11:3306" user="mycat"</span><br><span class="line">			password="(Uploo00king)"&gt;</span><br><span class="line">		&lt;/writeHost&gt;</span><br><span class="line">		&lt;writeHost host="masterb0" url="172.25.0.12:3306" user="mycat"</span><br><span class="line">			password="(Uploo00king)"&gt;</span><br><span class="line">		&lt;/writeHost&gt;</span><br><span class="line">		&lt;writeHost host="slavea0" url="172.25.0.13:3306" user="mycat"</span><br><span class="line">			password="(Uploo00king)"&gt;</span><br><span class="line">		&lt;/writeHost&gt;</span><br><span class="line">	&lt;/dataHost&gt;</span><br><span class="line"></span><br><span class="line">	&lt;dataHost name="mms" maxCon="1000" minCon="10" balance="1" dbType="mysql"</span><br><span class="line">		dbDriver="jdbc"&gt;</span><br><span class="line">		&lt;heartbeat&gt;select user()&lt;/heartbeat&gt;</span><br><span class="line">		&lt;writeHost host="slaveb0"</span><br><span class="line">		url="jdbc:mysql://172.25.0.14:3306" user="mycat" password="(Uploo00king)"&gt;</span><br><span class="line">			&lt;readHost host="workstation0" url="jdbc:mysql://172.25.0.10:3306" user="mycat" password="(Uploo00king)"/&gt;</span><br><span class="line">		&lt;/writeHost&gt;</span><br><span class="line">		&lt;writeHost host="dbproxy0"</span><br><span class="line">		url="jdbc:mysql://172.25.0.15:3306" user="mycat" password="(Uploo00king)"&gt;</span><br><span class="line">			&lt;readHost host="workstation0" url="jdbc:mysql://172.25.0.10:3306" user="mycat" password="(Uploo00king)"/&gt;</span><br><span class="line">		&lt;/writeHost&gt;</span><br><span class="line">	&lt;/dataHost&gt;</span><br><span class="line">&lt;/mycat:schema&gt;</span><br></pre></td></tr></tbody></table></figure>

<h4 id="6-2-5-rule-xml" class="article-heading"><a href="#6-2-5-rule-xml" class="headerlink" title="6.2.5 rule.xml"></a>6.2.5 rule.xml<a class="article-anchor" href="#6-2-5-rule-xml" aria-hidden="true"></a></h4><p><code>t2</code>表选择的分库规则为<code>rule='auto-sharding-long'</code></p>
<pre><code>&lt;tableRule name="auto-sharding-long"&gt;
	&lt;rule&gt;
		&lt;columns&gt;id&lt;/columns&gt;
		&lt;algorithm&gt;rang-long&lt;/algorithm&gt;
	&lt;/rule&gt;
&lt;/tableRule&gt;
</code></pre>
<ul>
<li><p>该规则使用的分库键为<code>t2</code>的<code>id</code>列；</p>
</li>
<li><p>该规则使用的算法为<code>rang-long</code></p>
<p><function name="rang-long" class="org.opencloudb.route.function.AutoPartitionByLong"><br><property name="mapFile">autopartition-long.txt</property><br><property name="count">16</property><br><property name="defaultNode">8</property></function></p>

</li>
<li><p>mapFile：算法明细存放于<code>autopartition-long.txt</code>文件</p>
</li>
<li><p>count：要分片的数据库节点数量，必须指定，否则没法分片</p>
</li>
<li><p>defaultNode：如果没有匹配到规则默认将数据写入哪个分片节点</p>
</li>
</ul>
<p>详细配置如下：</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line">&lt;!-- - - Licensed under the Apache License, Version 2.0 (the "License");</span><br><span class="line">	- you may not use this file except in compliance with the License. - You</span><br><span class="line">	may obtain a copy of the License at - - http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="line">	- - Unless required by applicable law or agreed to in writing, software -</span><br><span class="line">	distributed under the License is distributed on an "AS IS" BASIS, - WITHOUT</span><br><span class="line">	WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. - See the</span><br><span class="line">	License for the specific language governing permissions and - limitations</span><br><span class="line">	under the License. --&gt;</span><br><span class="line">&lt;!DOCTYPE mycat:rule SYSTEM "rule.dtd"&gt;</span><br><span class="line">&lt;mycat:rule xmlns:mycat="http://org.opencloudb/"&gt;</span><br><span class="line">	&lt;tableRule name="rule1"&gt;</span><br><span class="line">		&lt;rule&gt;</span><br><span class="line">			&lt;columns&gt;id&lt;/columns&gt;</span><br><span class="line">			&lt;algorithm&gt;func1&lt;/algorithm&gt;</span><br><span class="line">		&lt;/rule&gt;</span><br><span class="line">	&lt;/tableRule&gt;</span><br><span class="line"></span><br><span class="line">	&lt;tableRule name="rule2"&gt;</span><br><span class="line">		&lt;rule&gt;</span><br><span class="line">			&lt;columns&gt;user_id&lt;/columns&gt;</span><br><span class="line">			&lt;algorithm&gt;func1&lt;/algorithm&gt;</span><br><span class="line">		&lt;/rule&gt;</span><br><span class="line">	&lt;/tableRule&gt;</span><br><span class="line"></span><br><span class="line">	&lt;tableRule name="sharding-by-intfile"&gt;</span><br><span class="line">		&lt;rule&gt;</span><br><span class="line">			&lt;columns&gt;id&lt;/columns&gt;</span><br><span class="line">			&lt;algorithm&gt;hash-int&lt;/algorithm&gt;</span><br><span class="line">		&lt;/rule&gt;</span><br><span class="line">	&lt;/tableRule&gt;</span><br><span class="line">	&lt;tableRule name="auto-sharding-long"&gt;</span><br><span class="line">		&lt;rule&gt;</span><br><span class="line">			&lt;columns&gt;id&lt;/columns&gt;</span><br><span class="line">			&lt;algorithm&gt;rang-long&lt;/algorithm&gt;</span><br><span class="line">		&lt;/rule&gt;</span><br><span class="line">	&lt;/tableRule&gt;</span><br><span class="line">	&lt;tableRule name="mod-long"&gt;</span><br><span class="line">		&lt;rule&gt;</span><br><span class="line">			&lt;columns&gt;id&lt;/columns&gt;</span><br><span class="line">			&lt;algorithm&gt;mod-long&lt;/algorithm&gt;</span><br><span class="line">		&lt;/rule&gt;</span><br><span class="line">	&lt;/tableRule&gt;</span><br><span class="line">	&lt;tableRule name="sharding-by-murmur"&gt;</span><br><span class="line">		&lt;rule&gt;</span><br><span class="line">			&lt;columns&gt;id&lt;/columns&gt;</span><br><span class="line">			&lt;algorithm&gt;murmur&lt;/algorithm&gt;</span><br><span class="line">		&lt;/rule&gt;</span><br><span class="line">	&lt;/tableRule&gt;</span><br><span class="line">	&lt;tableRule name="sharding-by-month"&gt;</span><br><span class="line">		&lt;rule&gt;</span><br><span class="line">			&lt;columns&gt;create_date&lt;/columns&gt;</span><br><span class="line">			&lt;algorithm&gt;partbymonth&lt;/algorithm&gt;</span><br><span class="line">		&lt;/rule&gt;</span><br><span class="line">	&lt;/tableRule&gt;</span><br><span class="line">	&lt;tableRule name="latest-month-calldate"&gt;</span><br><span class="line">		&lt;rule&gt;</span><br><span class="line">			&lt;columns&gt;calldate&lt;/columns&gt;</span><br><span class="line">			&lt;algorithm&gt;latestMonth&lt;/algorithm&gt;</span><br><span class="line">		&lt;/rule&gt;</span><br><span class="line">	&lt;/tableRule&gt;</span><br><span class="line"></span><br><span class="line">	&lt;tableRule name="auto-sharding-rang-mod"&gt;</span><br><span class="line">		&lt;rule&gt;</span><br><span class="line">			&lt;columns&gt;id&lt;/columns&gt;</span><br><span class="line">			&lt;algorithm&gt;rang-mod&lt;/algorithm&gt;</span><br><span class="line">		&lt;/rule&gt;</span><br><span class="line">	&lt;/tableRule&gt;</span><br><span class="line"></span><br><span class="line">	&lt;tableRule name="jch"&gt;</span><br><span class="line">		&lt;rule&gt;</span><br><span class="line">			&lt;columns&gt;id&lt;/columns&gt;</span><br><span class="line">			&lt;algorithm&gt;jump-consistent-hash&lt;/algorithm&gt;</span><br><span class="line">		&lt;/rule&gt;</span><br><span class="line">	&lt;/tableRule&gt;</span><br><span class="line"></span><br><span class="line">	&lt;function name="murmur"</span><br><span class="line">		class="org.opencloudb.route.function.PartitionByMurmurHash"&gt;</span><br><span class="line">		&lt;property name="seed"&gt;0&lt;/property&gt;&lt;!-- 默认是0 --&gt;</span><br><span class="line">		&lt;property name="count"&gt;16&lt;/property&gt;&lt;!-- 要分片的数据库节点数量，必须指定，否则没法分片 --&gt;</span><br><span class="line">		&lt;property name="virtualBucketTimes"&gt;160&lt;/property&gt;&lt;!-- 一个实际的数据库节点被映射为这么多虚拟节点，默认是160倍，也就是虚拟节点数是物理节点数的160倍 --&gt;</span><br><span class="line">		&lt;!-- &lt;property name="weightMapFile"&gt;weightMapFile&lt;/property&gt; 节点的权重，没有指定权重的节点默认是1。以properties文件的格式填写，以从0开始到count-1的整数值也就是节点索引为key，以节点权重值为值。所有权重值必须是正整数，否则以1代替 --&gt;</span><br><span class="line">		&lt;!-- &lt;property name="bucketMapPath"&gt;/etc/mycat/bucketMapPath&lt;/property&gt;</span><br><span class="line">			用于测试时观察各物理节点与虚拟节点的分布情况，如果指定了这个属性，会把虚拟节点的murmur hash值与物理节点的映射按行输出到这个文件，没有默认值，如果不指定，就不会输出任何东西 --&gt;</span><br><span class="line">	&lt;/function&gt;</span><br><span class="line">	&lt;function name="hash-int"</span><br><span class="line">		class="org.opencloudb.route.function.PartitionByFileMap"&gt;</span><br><span class="line">		&lt;property name="count"&gt;16&lt;/property&gt;&lt;!-- 要分片的数据库节点数量，必须指定，否则没法分片 --&gt;</span><br><span class="line">		&lt;property name="mapFile"&gt;partition-hash-int.txt&lt;/property&gt;</span><br><span class="line">		&lt;property name="defaultNode"&gt;8&lt;/property&gt;</span><br><span class="line">	&lt;/function&gt;</span><br><span class="line">	&lt;function name="rang-long"</span><br><span class="line">		class="org.opencloudb.route.function.AutoPartitionByLong"&gt;</span><br><span class="line">		&lt;property name="mapFile"&gt;autopartition-long.txt&lt;/property&gt;</span><br><span class="line">		&lt;property name="count"&gt;16&lt;/property&gt;</span><br><span class="line">		&lt;property name="defaultNode"&gt;8&lt;/property&gt;</span><br><span class="line">	&lt;/function&gt;</span><br><span class="line">	&lt;function name="mod-long" class="org.opencloudb.route.function.PartitionByMod"&gt;</span><br><span class="line">		&lt;!-- how many data nodes --&gt;</span><br><span class="line">		&lt;property name="count"&gt;16&lt;/property&gt;</span><br><span class="line">	&lt;/function&gt;</span><br><span class="line"></span><br><span class="line">	&lt;function name="func1" class="org.opencloudb.route.function.PartitionByLong"&gt;</span><br><span class="line">		&lt;property name="partitionCount"&gt;8&lt;/property&gt;</span><br><span class="line">		&lt;property name="partitionLength"&gt;128&lt;/property&gt;</span><br><span class="line">	&lt;/function&gt;</span><br><span class="line">	&lt;function name="latestMonth"</span><br><span class="line">		class="org.opencloudb.route.function.LatestMonthPartion"&gt;</span><br><span class="line">		&lt;property name="splitOneDay"&gt;24&lt;/property&gt;</span><br><span class="line">	&lt;/function&gt;</span><br><span class="line">	&lt;function name="partbymonth"</span><br><span class="line">		class="org.opencloudb.route.function.PartitionByMonth"&gt;</span><br><span class="line">		&lt;property name="dateFormat"&gt;yyyy-MM-dd&lt;/property&gt;</span><br><span class="line">		&lt;property name="sBeginDate"&gt;2015-01-01&lt;/property&gt;</span><br><span class="line">	&lt;/function&gt;</span><br><span class="line"></span><br><span class="line">	&lt;function name="rang-mod" class="org.opencloudb.route.function.PartitionByRangeMod"&gt;</span><br><span class="line">        	&lt;property name="mapFile"&gt;partition-range-mod.txt&lt;/property&gt;</span><br><span class="line">		&lt;property name="count"&gt;16&lt;/property&gt;&lt;!-- 要分片的数据库节点数量，必须指定，否则没法分片 --&gt;</span><br><span class="line">		&lt;property name="defaultNode"&gt;0&lt;/property&gt;</span><br><span class="line">	&lt;/function&gt;</span><br><span class="line"></span><br><span class="line">	&lt;function name="jump-consistent-hash" class="org.opencloudb.route.function.PartitionByJumpConsistentHash"&gt;</span><br><span class="line">		&lt;property name="totalBuckets"&gt;3&lt;/property&gt;</span><br><span class="line">	&lt;/function&gt;</span><br><span class="line">&lt;/mycat:rule&gt;</span><br></pre></td></tr></tbody></table></figure>

<h4 id="6-2-6-autopartition-long-txt" class="article-heading"><a href="#6-2-6-autopartition-long-txt" class="headerlink" title="6.2.6 autopartition-long.txt"></a>6.2.6 autopartition-long.txt<a class="article-anchor" href="#6-2-6-autopartition-long-txt" aria-hidden="true"></a></h4><p>若id在0-1000,则存放于0号分片节点；</p>
<p>若id在10000-20000，则存放于1号分片节点；</p>
<p>以此类推。</p>
<blockquote>
<p>如何知晓后端节点为几号分片呢？</p>
<p>例如此处schema.xml配置中存在16个datanode，分别为dn1,dn2,dn3..dn16;那么dn1就是0号分片，dn2为1号分片，一次类推dn16就是第15号分片节点。</p>
</blockquote>
<p>详细配置如下：</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">range start-end ,data node index</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">K=1000,M=10000.</span></span><br><span class="line">0-1M=0</span><br><span class="line">1M-2M=1</span><br><span class="line">2M-3M=2</span><br><span class="line">3M-4M=3</span><br><span class="line">4M-5M=4</span><br><span class="line">5M-6M=5</span><br><span class="line">6M-7M=6</span><br><span class="line">7M-8M=7</span><br><span class="line">8M-9M=8</span><br><span class="line">9M-10M=9</span><br><span class="line">10M-11M=10</span><br><span class="line">11M-12M=11</span><br><span class="line">12M-13M=12</span><br><span class="line">13M-14M=13</span><br><span class="line">14M-15M=14</span><br><span class="line">15M-16M=15</span><br></pre></td></tr></tbody></table></figure>

<p>这里特别强调一下分片规则的选择问题，如果某个表的数据有明显的时间特征，比如订单、交易记录等，则他们通常比较合适用时间范围分片，因为具有时效性的数据，我们往往关注其近期的数据，查询条件中往往带有时间字段进行过滤，比较好的方案是，当前活跃的数据，采用跨度比较短的时间段进行分片，而历史性的数据，则采用比较长的跨度存储。</p>
<p>总体上来说，分片的选择是取决于最频繁的查询SQL的条件，因为不带任何Where语句的查询SQL，会便利所有的分片，性能相对最差，因此这种SQL越多，对系统的影响越大，所以我们要尽量避免这种SQL的产生。</p>
<h3 id="6-3-数据库实例" class="article-heading"><a href="#6-3-数据库实例" class="headerlink" title="6.3 数据库实例"></a>6.3 数据库实例<a class="article-anchor" href="#6-3-数据库实例" aria-hidden="true"></a></h3><h4 id="6-3-1-添加对mycat的授权" class="article-heading"><a href="#6-3-1-添加对mycat的授权" class="headerlink" title="6.3.1 添加对mycat的授权"></a>6.3.1 添加对mycat的授权<a class="article-anchor" href="#6-3-1-添加对mycat的授权" aria-hidden="true"></a></h4><p>pxc 和 mms 都需要执行：</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">grant all on *.* to mycat@'%' identified by '(Uploo00king)';</span><br><span class="line">flush privileges;</span><br></pre></td></tr></tbody></table></figure>

<h4 id="6-3-2-建库建表" class="article-heading"><a href="#6-3-2-建库建表" class="headerlink" title="6.3.2 建库建表"></a>6.3.2 建库建表<a class="article-anchor" href="#6-3-2-建库建表" aria-hidden="true"></a></h4><p>根据分库分表的规则，在后端数据库集群实例中建库建表。本实例中只做了分库，没有做分表，如果分表那么create table的时候在末尾添加分表属性<code>PARTITION BY</code>即可。</p>
<blockquote>
<p>分表例如：</p>
</blockquote>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">CREATE TABLE `fx_achievement_p` (</span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT ,</span><br><span class="line">  `user_key` varchar(45) DEFAULT NULL,</span><br><span class="line">  `card_level` varchar(1) DEFAULT NULL,</span><br><span class="line">  `pay_date` datetime ,</span><br><span class="line">primary key (id,pay_date),</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=13828002 DEFAULT CHARSET=utf8</span><br><span class="line">PARTITION BY RANGE(TO_DAYS(pay_date))</span><br><span class="line">(PARTITION p1 VALUES LESS THAN (TO_DAYS('2016-12-01'))ENGINE = InnoDB,</span><br><span class="line"> PARTITION p2 VALUES LESS THAN (TO_DAYS('2017-01-01'))ENGINE = InnoDB,</span><br><span class="line"> PARTITION p3 VALUES LESS THAN (TO_DAYS('2017-02-01'))ENGINE = InnoDB,</span><br><span class="line"> PARTITION p4 VALUES LESS THAN (TO_DAYS('2017-03-01'))ENGINE = InnoDB,</span><br><span class="line"> PARTITION p5 VALUES LESS THAN (TO_DAYS('2017-04-01'))ENGINE = InnoDB,</span><br><span class="line"> PARTITION pall VALUES LESS THAN maxvalue ENGINE = InnoDB);</span><br></pre></td></tr></tbody></table></figure>

<p>pxc 和 mms 分别建8个库，每个库中建相同结构的表，此处脚本批量完成。</p>
<p>initmysql.sh</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">init.sql</span></span><br><span class="line">for i in `seq 1 8`</span><br><span class="line">do</span><br><span class="line">	echo "create database db2_0${i};" &gt;&gt; init.sql</span><br><span class="line">	echo "use db2_0${i};" &gt;&gt; init.sql</span><br><span class="line">	echo "create table t2 (id int primary key,name varchar(30));" &gt;&gt; init.sql</span><br><span class="line">done</span><br></pre></td></tr></tbody></table></figure>

<p>运行initmysql.sh后在当前目录下生成init.sql文件</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">create database db2_01;</span><br><span class="line">use db2_01;</span><br><span class="line">create table t2 (id int primary key,name varchar(30));</span><br><span class="line">create database db2_02;</span><br><span class="line">use db2_02;</span><br><span class="line">create table t2 (id int primary key,name varchar(30));</span><br><span class="line">create database db2_03;</span><br><span class="line">use db2_03;</span><br><span class="line">create table t2 (id int primary key,name varchar(30));</span><br><span class="line">create database db2_04;</span><br><span class="line">use db2_04;</span><br><span class="line">create table t2 (id int primary key,name varchar(30));</span><br><span class="line">create database db2_05;</span><br><span class="line">use db2_05;</span><br><span class="line">create table t2 (id int primary key,name varchar(30));</span><br><span class="line">create database db2_06;</span><br><span class="line">use db2_06;</span><br><span class="line">create table t2 (id int primary key,name varchar(30));</span><br><span class="line">create database db2_07;</span><br><span class="line">use db2_07;</span><br><span class="line">create table t2 (id int primary key,name varchar(30));</span><br><span class="line">create database db2_08;</span><br><span class="line">use db2_08;</span><br><span class="line">create table t2 (id int primary key,name varchar(30));</span><br></pre></td></tr></tbody></table></figure>

<p>将init.sql文件导入数据库</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">mysql -uroot -p'(Uploo00king)' &lt; init.sql</span><br></pre></td></tr></tbody></table></figure>

<h3 id="6-4-启动mycat服务" class="article-heading"><a href="#6-4-启动mycat服务" class="headerlink" title="6.4 启动mycat服务"></a>6.4 启动mycat服务<a class="article-anchor" href="#6-4-启动mycat服务" aria-hidden="true"></a></h3><h4 id="6-4-1-启动服务" class="article-heading"><a href="#6-4-1-启动服务" class="headerlink" title="6.4.1 启动服务"></a>6.4.1 启动服务<a class="article-anchor" href="#6-4-1-启动服务" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">mycat start</span><br><span class="line">mycat status</span><br></pre></td></tr></tbody></table></figure>

<h4 id="6-4-2-查看守护进程" class="article-heading"><a href="#6-4-2-查看守护进程" class="headerlink" title="6.4.2 查看守护进程"></a>6.4.2 查看守护进程<a class="article-anchor" href="#6-4-2-查看守护进程" aria-hidden="true"></a></h4><figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">ps -ef|grep java</span><br><span class="line"></span><br><span class="line">root     18334 18332  7 15:54 ?        00:00:06 java -DMYCAT_HOME=. -server -XX:MaxPermSize=64M -XX:+AggressiveOpts -XX:MaxDirectMemorySize=2G -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=1984 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Xmx4G -Xms1G -Djava.library.path=lib -classpath lib/wrapper.jar:conf:lib/zookeeper-3.4.6.jar:lib/jline-0.9.94.jar:lib/ehcache-core-2.6.11.jar:lib/log4j-1.2.17.jar:lib/guava-18.0.jar:lib/libwrapper-linux-x86-32.so:lib/netty-3.7.0.Final.jar:lib/mapdb-1.0.7.jar:lib/xml-apis-1.0.b2.jar:lib/slf4j-api-1.7.12.jar:lib/leveldb-api-0.7.jar:lib/wrapper.jar:lib/slf4j-log4j12-1.7.12.jar:lib/json-20151123.jar:lib/curator-framework-2.9.0.jar:lib/mongo-java-driver-2.11.4.jar:lib/druid-1.0.14.jar:lib/libwrapper-linux-ppc-64.so:lib/Mycat-server-1.5.1-RELEASE.jar:lib/leveldb-0.7.jar:lib/fastjson-1.2.7.jar:lib/sequoiadb-java-driver-1.0-20150615.070208-1.jar:lib/snakeyaml-1.16.jar:lib/univocity-parsers-1.5.4.jar:lib/curator-client-2.9.0.jar:lib/libwrapper-linux-x86-64.so:lib/dom4j-1.6.1.jar:lib/mysql-connector-java-5.1.45-bin.jar -Dwrapper.key=eOdzGSNOEVR9mMJA -Dwrapper.port=32000 -Dwrapper.jvm.port.min=31000 -Dwrapper.jvm.port.max=31999 -Dwrapper.pid=18332 -Dwrapper.version=3.2.3 -Dwrapper.native_library=wrapper -Dwrapper.service=TRUE -Dwrapper.cpu.timeout=10 -Dwrapper.jvmid=1 org.tanukisoftware.wrapper.WrapperSimpleApp org.opencloudb.MycatStartup start</span><br><span class="line">root     18422 17766  0 15:56 pts/0    00:00:00 grep --color=auto java</span><br></pre></td></tr></tbody></table></figure>

<h4 id="6-4-3-查看监听" class="article-heading"><a href="#6-4-3-查看监听" class="headerlink" title="6.4.3 查看监听"></a>6.4.3 查看监听<a class="article-anchor" href="#6-4-3-查看监听" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ss -luntp|grep java</span><br><span class="line"></span><br><span class="line">tcp    LISTEN     0      1      127.0.0.1:32000                 *:*                   users:(("java",pid=18334,fd=4))</span><br><span class="line">tcp    LISTEN     0      100      :::9066                 :::*                   users:(("java",pid=18334,fd=56))</span><br><span class="line">tcp    LISTEN     0      50       :::59601                :::*                   users:(("java",pid=18334,fd=39))</span><br><span class="line">tcp    LISTEN     0      50       :::36030                :::*                   users:(("java",pid=18334,fd=37))</span><br><span class="line">tcp    LISTEN     0      50       :::1984                 :::*                   users:(("java",pid=18334,fd=38))</span><br><span class="line">tcp    LISTEN     0      100      :::8066                 :::*                   users:(("java",pid=18334,fd=60))</span><br></pre></td></tr></tbody></table></figure>

<h3 id="6-5-验证结果" class="article-heading"><a href="#6-5-验证结果" class="headerlink" title="6.5 验证结果"></a>6.5 验证结果<a class="article-anchor" href="#6-5-验证结果" aria-hidden="true"></a></h3><p>分别连接mycat_01和mycat_02的8066和9066端口</p>
<h4 id="6-5-1-验证mycat-01" class="article-heading"><a href="#6-5-1-验证mycat-01" class="headerlink" title="6.5.1 验证mycat_01"></a>6.5.1 验证mycat_01<a class="article-anchor" href="#6-5-1-验证mycat-01" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">[root@dbproxy0 conf]# mysql -uroot -puplooking -h172.25.0.10 -P8066 -e "show databases"</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+----------+</span><br><span class="line">| DATABASE |</span><br><span class="line">+----------+</span><br><span class="line">| ecshop   |</span><br><span class="line">+----------+</span><br><span class="line">[root@dbproxy0 conf]# mysql -uroot -puplooking -h172.25.0.10 -P8066 ecshop -e "show tables;"</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+------------------+</span><br><span class="line">| Tables in ecshop |</span><br><span class="line">+------------------+</span><br><span class="line">| t2               |</span><br><span class="line">+------------------+</span><br><span class="line">[root@dbproxy0 conf]# mysql -uroot -puplooking -h172.25.0.10 -P9066 -e "show @@datanode"</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+------+----------------------+-------+-------+--------+------+------+---------+------------+----------+---------+---------------+</span><br><span class="line">| NAME | DATHOST              | INDEX | TYPE  | ACTIVE | IDLE | SIZE | EXECUTE | TOTAL_TIME | MAX_TIME | MAX_SQL | RECOVERY_TIME |</span><br><span class="line">+------+----------------------+-------+-------+--------+------+------+---------+------------+----------+---------+---------------+</span><br><span class="line">| dn1  | pxc-cluster-1/db2_01 |     0 | mysql |      0 |    2 | 1000 |      20 |          0 |        0 |       0 |            -1 |</span><br><span class="line">| dn10 | mms/db2_02           |     0 | mysql |      0 |    1 | 1000 |       1 |          0 |        0 |       0 |            -1 |</span><br><span class="line">| dn11 | mms/db2_03           |     0 | mysql |      0 |    1 | 1000 |       1 |          0 |        0 |       0 |            -1 |</span><br><span class="line">| dn12 | mms/db2_04           |     0 | mysql |      0 |    1 | 1000 |       1 |          0 |        0 |       0 |            -1 |</span><br><span class="line">| dn13 | mms/db2_05           |     0 | mysql |      0 |    1 | 1000 |       1 |          0 |        0 |       0 |            -1 |</span><br><span class="line">| dn14 | mms/db2_06           |     0 | mysql |      0 |    1 | 1000 |       1 |          0 |        0 |       0 |            -1 |</span><br><span class="line">| dn15 | mms/db2_07           |     0 | mysql |      0 |    2 | 1000 |       2 |          0 |        0 |       0 |            -1 |</span><br><span class="line">| dn16 | mms/db2_08           |     0 | mysql |      0 |    2 | 1000 |       2 |          0 |        0 |       0 |            -1 |</span><br><span class="line">| dn2  | pxc-cluster-1/db2_02 |     0 | mysql |      0 |    1 | 1000 |       1 |          0 |        0 |       0 |            -1 |</span><br><span class="line">| dn3  | pxc-cluster-1/db2_03 |     0 | mysql |      0 |    2 | 1000 |       2 |          0 |        0 |       0 |            -1 |</span><br><span class="line">| dn4  | pxc-cluster-1/db2_04 |     0 | mysql |      0 |    1 | 1000 |       1 |          0 |        0 |       0 |            -1 |</span><br><span class="line">| dn5  | pxc-cluster-1/db2_05 |     0 | mysql |      0 |    1 | 1000 |       1 |          0 |        0 |       0 |            -1 |</span><br><span class="line">| dn6  | pxc-cluster-1/db2_06 |     0 | mysql |      0 |    1 | 1000 |       1 |          0 |        0 |       0 |            -1 |</span><br><span class="line">| dn7  | pxc-cluster-1/db2_07 |     0 | mysql |      0 |    1 | 1000 |       1 |          0 |        0 |       0 |            -1 |</span><br><span class="line">| dn8  | pxc-cluster-1/db2_08 |     0 | mysql |      0 |    1 | 1000 |       1 |          0 |        0 |       0 |            -1 |</span><br><span class="line">| dn9  | mms/db2_01           |     0 | mysql |      0 |    1 | 1000 |       1 |          0 |        0 |       0 |            -1 |</span><br><span class="line">+------+----------------------+-------+-------+--------+------+------+---------+------------+----------+---------+---------------+</span><br><span class="line">[root@dbproxy0 conf]# mysql -uroot -puplooking -h172.25.0.10 -P9066 -e "show @@datasource"</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+----------+--------------+-------+-------------+------+------+--------+------+------+---------+</span><br><span class="line">| DATANODE | NAME         | TYPE  | HOST        | PORT | W/R  | ACTIVE | IDLE | SIZE | EXECUTE |</span><br><span class="line">+----------+--------------+-------+-------------+------+------+--------+------+------+---------+</span><br><span class="line">| dn16     | slaveb0      | mysql | 172.25.0.14 | 3306 | W    |      0 |   10 | 1000 |      10 |</span><br><span class="line">| dn16     | dbproxy0     | mysql | 172.25.0.15 | 3306 | W    |      0 |    0 | 1000 |       0 |</span><br><span class="line">| dn16     | workstation0 | mysql | 172.25.0.10 | 3306 | R    |      0 |    3 | 1000 |       3 |</span><br><span class="line">| dn16     | workstation0 | mysql | 172.25.0.10 | 3306 | R    |      0 |    3 | 1000 |       3 |</span><br><span class="line">| dn15     | slaveb0      | mysql | 172.25.0.14 | 3306 | W    |      0 |   10 | 1000 |      10 |</span><br><span class="line">| dn15     | dbproxy0     | mysql | 172.25.0.15 | 3306 | W    |      0 |    0 | 1000 |       0 |</span><br><span class="line">| dn15     | workstation0 | mysql | 172.25.0.10 | 3306 | R    |      0 |    3 | 1000 |       3 |</span><br><span class="line">| dn15     | workstation0 | mysql | 172.25.0.10 | 3306 | R    |      0 |    3 | 1000 |       3 |</span><br><span class="line">| dn14     | slaveb0      | mysql | 172.25.0.14 | 3306 | W    |      0 |   10 | 1000 |      10 |</span><br><span class="line">| dn14     | dbproxy0     | mysql | 172.25.0.15 | 3306 | W    |      0 |    0 | 1000 |       0 |</span><br><span class="line">| dn14     | workstation0 | mysql | 172.25.0.10 | 3306 | R    |      0 |    3 | 1000 |       3 |</span><br><span class="line">| dn14     | workstation0 | mysql | 172.25.0.10 | 3306 | R    |      0 |    3 | 1000 |       3 |</span><br><span class="line">| dn13     | slaveb0      | mysql | 172.25.0.14 | 3306 | W    |      0 |   10 | 1000 |      10 |</span><br><span class="line">| dn13     | dbproxy0     | mysql | 172.25.0.15 | 3306 | W    |      0 |    0 | 1000 |       0 |</span><br><span class="line">| dn13     | workstation0 | mysql | 172.25.0.10 | 3306 | R    |      0 |    3 | 1000 |       3 |</span><br><span class="line">| dn13     | workstation0 | mysql | 172.25.0.10 | 3306 | R    |      0 |    3 | 1000 |       3 |</span><br><span class="line">| dn12     | slaveb0      | mysql | 172.25.0.14 | 3306 | W    |      0 |   10 | 1000 |      10 |</span><br><span class="line">| dn12     | dbproxy0     | mysql | 172.25.0.15 | 3306 | W    |      0 |    0 | 1000 |       0 |</span><br><span class="line">| dn12     | workstation0 | mysql | 172.25.0.10 | 3306 | R    |      0 |    3 | 1000 |       3 |</span><br><span class="line">| dn12     | workstation0 | mysql | 172.25.0.10 | 3306 | R    |      0 |    3 | 1000 |       3 |</span><br><span class="line">| dn11     | slaveb0      | mysql | 172.25.0.14 | 3306 | W    |      0 |   10 | 1000 |      10 |</span><br><span class="line">| dn11     | dbproxy0     | mysql | 172.25.0.15 | 3306 | W    |      0 |    0 | 1000 |       0 |</span><br><span class="line">| dn11     | workstation0 | mysql | 172.25.0.10 | 3306 | R    |      0 |    3 | 1000 |       3 |</span><br><span class="line">| dn11     | workstation0 | mysql | 172.25.0.10 | 3306 | R    |      0 |    3 | 1000 |       3 |</span><br><span class="line">| dn1      | mastera0     | mysql | 172.25.0.11 | 3306 | W    |      0 |   10 | 1000 |      28 |</span><br><span class="line">| dn1      | masterb0     | mysql | 172.25.0.12 | 3306 | W    |      0 |    1 | 1000 |      18 |</span><br><span class="line">| dn1      | slavea0      | mysql | 172.25.0.13 | 3306 | W    |      0 |    1 | 1000 |      18 |</span><br><span class="line">| dn10     | slaveb0      | mysql | 172.25.0.14 | 3306 | W    |      0 |   10 | 1000 |      10 |</span><br><span class="line">| dn10     | dbproxy0     | mysql | 172.25.0.15 | 3306 | W    |      0 |    0 | 1000 |       0 |</span><br><span class="line">| dn10     | workstation0 | mysql | 172.25.0.10 | 3306 | R    |      0 |    3 | 1000 |       3 |</span><br><span class="line">| dn10     | workstation0 | mysql | 172.25.0.10 | 3306 | R    |      0 |    3 | 1000 |       3 |</span><br><span class="line">| dn3      | mastera0     | mysql | 172.25.0.11 | 3306 | W    |      0 |   10 | 1000 |      28 |</span><br><span class="line">| dn3      | masterb0     | mysql | 172.25.0.12 | 3306 | W    |      0 |    1 | 1000 |      18 |</span><br><span class="line">| dn3      | slavea0      | mysql | 172.25.0.13 | 3306 | W    |      0 |    1 | 1000 |      18 |</span><br><span class="line">| dn2      | mastera0     | mysql | 172.25.0.11 | 3306 | W    |      0 |   10 | 1000 |      28 |</span><br><span class="line">| dn2      | masterb0     | mysql | 172.25.0.12 | 3306 | W    |      0 |    1 | 1000 |      18 |</span><br><span class="line">| dn2      | slavea0      | mysql | 172.25.0.13 | 3306 | W    |      0 |    1 | 1000 |      18 |</span><br><span class="line">| dn5      | mastera0     | mysql | 172.25.0.11 | 3306 | W    |      0 |   10 | 1000 |      28 |</span><br><span class="line">| dn5      | masterb0     | mysql | 172.25.0.12 | 3306 | W    |      0 |    1 | 1000 |      18 |</span><br><span class="line">| dn5      | slavea0      | mysql | 172.25.0.13 | 3306 | W    |      0 |    1 | 1000 |      18 |</span><br><span class="line">| dn4      | mastera0     | mysql | 172.25.0.11 | 3306 | W    |      0 |   10 | 1000 |      28 |</span><br><span class="line">| dn4      | masterb0     | mysql | 172.25.0.12 | 3306 | W    |      0 |    1 | 1000 |      18 |</span><br><span class="line">| dn4      | slavea0      | mysql | 172.25.0.13 | 3306 | W    |      0 |    1 | 1000 |      18 |</span><br><span class="line">| dn7      | mastera0     | mysql | 172.25.0.11 | 3306 | W    |      0 |   10 | 1000 |      28 |</span><br><span class="line">| dn7      | masterb0     | mysql | 172.25.0.12 | 3306 | W    |      0 |    1 | 1000 |      18 |</span><br><span class="line">| dn7      | slavea0      | mysql | 172.25.0.13 | 3306 | W    |      0 |    1 | 1000 |      18 |</span><br><span class="line">| dn6      | mastera0     | mysql | 172.25.0.11 | 3306 | W    |      0 |   10 | 1000 |      28 |</span><br><span class="line">| dn6      | masterb0     | mysql | 172.25.0.12 | 3306 | W    |      0 |    1 | 1000 |      18 |</span><br><span class="line">| dn6      | slavea0      | mysql | 172.25.0.13 | 3306 | W    |      0 |    1 | 1000 |      18 |</span><br><span class="line">| dn9      | slaveb0      | mysql | 172.25.0.14 | 3306 | W    |      0 |   10 | 1000 |      10 |</span><br><span class="line">| dn9      | dbproxy0     | mysql | 172.25.0.15 | 3306 | W    |      0 |    0 | 1000 |       0 |</span><br><span class="line">| dn9      | workstation0 | mysql | 172.25.0.10 | 3306 | R    |      0 |    3 | 1000 |       3 |</span><br><span class="line">| dn9      | workstation0 | mysql | 172.25.0.10 | 3306 | R    |      0 |    3 | 1000 |       3 |</span><br><span class="line">| dn8      | mastera0     | mysql | 172.25.0.11 | 3306 | W    |      0 |   10 | 1000 |      28 |</span><br><span class="line">| dn8      | masterb0     | mysql | 172.25.0.12 | 3306 | W    |      0 |    1 | 1000 |      18 |</span><br><span class="line">| dn8      | slavea0      | mysql | 172.25.0.13 | 3306 | W    |      0 |    1 | 1000 |      18 |</span><br><span class="line">+----------+--------------+-------+-------------+------+------+--------+------+------+---------+</span><br></pre></td></tr></tbody></table></figure>

<h4 id="6-5-2-验证mycat-02" class="article-heading"><a href="#6-5-2-验证mycat-02" class="headerlink" title="6.5.2 验证mycat_02"></a>6.5.2 验证mycat_02<a class="article-anchor" href="#6-5-2-验证mycat-02" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">[root@workstation0 ~]# mysql -uroot -puplooking -h172.25.0.15 -P8066 -e "show databases"</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+----------+</span><br><span class="line">| DATABASE |</span><br><span class="line">+----------+</span><br><span class="line">| ecshop   |</span><br><span class="line">+----------+</span><br><span class="line">[root@workstation0 ~]# mysql -uroot -puplooking -h172.25.0.15 -P8066 ecshop -e "show tables"</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+------------------+</span><br><span class="line">| Tables in ecshop |</span><br><span class="line">+------------------+</span><br><span class="line">| t2               |</span><br><span class="line">+------------------+</span><br><span class="line">[root@dbproxy0 conf]# mysql -uroot -puplooking -h172.25.0.15 -P9066 -e "show @@datanode"</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+------+----------------------+-------+-------+--------+------+------+---------+------------+----------+---------+---------------+</span><br><span class="line">| NAME | DATHOST              | INDEX | TYPE  | ACTIVE | IDLE | SIZE | EXECUTE | TOTAL_TIME | MAX_TIME | MAX_SQL | RECOVERY_TIME |</span><br><span class="line">+------+----------------------+-------+-------+--------+------+------+---------+------------+----------+---------+---------------+</span><br><span class="line">| dn1  | pxc-cluster-1/db2_01 |     0 | mysql |      0 |    2 | 1000 |      20 |          0 |        0 |       0 |            -1 |</span><br><span class="line">| dn10 | mms/db2_02           |     0 | mysql |      0 |    1 | 1000 |       1 |          0 |        0 |       0 |            -1 |</span><br><span class="line">| dn11 | mms/db2_03           |     0 | mysql |      0 |    1 | 1000 |       1 |          0 |        0 |       0 |            -1 |</span><br><span class="line">| dn12 | mms/db2_04           |     0 | mysql |      0 |    1 | 1000 |       1 |          0 |        0 |       0 |            -1 |</span><br><span class="line">| dn13 | mms/db2_05           |     0 | mysql |      0 |    1 | 1000 |       1 |          0 |        0 |       0 |            -1 |</span><br><span class="line">| dn14 | mms/db2_06           |     0 | mysql |      0 |    1 | 1000 |       1 |          0 |        0 |       0 |            -1 |</span><br><span class="line">| dn15 | mms/db2_07           |     0 | mysql |      0 |    2 | 1000 |       2 |          0 |        0 |       0 |            -1 |</span><br><span class="line">| dn16 | mms/db2_08           |     0 | mysql |      0 |    2 | 1000 |       2 |          0 |        0 |       0 |            -1 |</span><br><span class="line">| dn2  | pxc-cluster-1/db2_02 |     0 | mysql |      0 |    1 | 1000 |       1 |          0 |        0 |       0 |            -1 |</span><br><span class="line">| dn3  | pxc-cluster-1/db2_03 |     0 | mysql |      0 |    2 | 1000 |       2 |          0 |        0 |       0 |            -1 |</span><br><span class="line">| dn4  | pxc-cluster-1/db2_04 |     0 | mysql |      0 |    1 | 1000 |       1 |          0 |        0 |       0 |            -1 |</span><br><span class="line">| dn5  | pxc-cluster-1/db2_05 |     0 | mysql |      0 |    1 | 1000 |       1 |          0 |        0 |       0 |            -1 |</span><br><span class="line">| dn6  | pxc-cluster-1/db2_06 |     0 | mysql |      0 |    1 | 1000 |       1 |          0 |        0 |       0 |            -1 |</span><br><span class="line">| dn7  | pxc-cluster-1/db2_07 |     0 | mysql |      0 |    1 | 1000 |       1 |          0 |        0 |       0 |            -1 |</span><br><span class="line">| dn8  | pxc-cluster-1/db2_08 |     0 | mysql |      0 |    1 | 1000 |       1 |          0 |        0 |       0 |            -1 |</span><br><span class="line">| dn9  | mms/db2_01           |     0 | mysql |      0 |    1 | 1000 |       1 |          0 |        0 |       0 |            -1 |</span><br><span class="line">+------+----------------------+-------+-------+--------+------+------+---------+------------+----------+---------+---------------+</span><br><span class="line">[root@dbproxy0 conf]# mysql -uroot -puplooking -h172.25.0.15 -P9066 -e "show @@datasource"</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+----------+--------------+-------+-------------+------+------+--------+------+------+---------+</span><br><span class="line">| DATANODE | NAME         | TYPE  | HOST        | PORT | W/R  | ACTIVE | IDLE | SIZE | EXECUTE |</span><br><span class="line">+----------+--------------+-------+-------------+------+------+--------+------+------+---------+</span><br><span class="line">| dn16     | slaveb0      | mysql | 172.25.0.14 | 3306 | W    |      0 |   10 | 1000 |      10 |</span><br><span class="line">| dn16     | dbproxy0     | mysql | 172.25.0.15 | 3306 | W    |      0 |    0 | 1000 |       0 |</span><br><span class="line">| dn16     | workstation0 | mysql | 172.25.0.10 | 3306 | R    |      0 |    3 | 1000 |       3 |</span><br><span class="line">| dn16     | workstation0 | mysql | 172.25.0.10 | 3306 | R    |      0 |    3 | 1000 |       3 |</span><br><span class="line">| dn15     | slaveb0      | mysql | 172.25.0.14 | 3306 | W    |      0 |   10 | 1000 |      10 |</span><br><span class="line">| dn15     | dbproxy0     | mysql | 172.25.0.15 | 3306 | W    |      0 |    0 | 1000 |       0 |</span><br><span class="line">| dn15     | workstation0 | mysql | 172.25.0.10 | 3306 | R    |      0 |    3 | 1000 |       3 |</span><br><span class="line">| dn15     | workstation0 | mysql | 172.25.0.10 | 3306 | R    |      0 |    3 | 1000 |       3 |</span><br><span class="line">| dn14     | slaveb0      | mysql | 172.25.0.14 | 3306 | W    |      0 |   10 | 1000 |      10 |</span><br><span class="line">| dn14     | dbproxy0     | mysql | 172.25.0.15 | 3306 | W    |      0 |    0 | 1000 |       0 |</span><br><span class="line">| dn14     | workstation0 | mysql | 172.25.0.10 | 3306 | R    |      0 |    3 | 1000 |       3 |</span><br><span class="line">| dn14     | workstation0 | mysql | 172.25.0.10 | 3306 | R    |      0 |    3 | 1000 |       3 |</span><br><span class="line">| dn13     | slaveb0      | mysql | 172.25.0.14 | 3306 | W    |      0 |   10 | 1000 |      10 |</span><br><span class="line">| dn13     | dbproxy0     | mysql | 172.25.0.15 | 3306 | W    |      0 |    0 | 1000 |       0 |</span><br><span class="line">| dn13     | workstation0 | mysql | 172.25.0.10 | 3306 | R    |      0 |    3 | 1000 |       3 |</span><br><span class="line">| dn13     | workstation0 | mysql | 172.25.0.10 | 3306 | R    |      0 |    3 | 1000 |       3 |</span><br><span class="line">| dn12     | slaveb0      | mysql | 172.25.0.14 | 3306 | W    |      0 |   10 | 1000 |      10 |</span><br><span class="line">| dn12     | dbproxy0     | mysql | 172.25.0.15 | 3306 | W    |      0 |    0 | 1000 |       0 |</span><br><span class="line">| dn12     | workstation0 | mysql | 172.25.0.10 | 3306 | R    |      0 |    3 | 1000 |       3 |</span><br><span class="line">| dn12     | workstation0 | mysql | 172.25.0.10 | 3306 | R    |      0 |    3 | 1000 |       3 |</span><br><span class="line">| dn11     | slaveb0      | mysql | 172.25.0.14 | 3306 | W    |      0 |   10 | 1000 |      10 |</span><br><span class="line">| dn11     | dbproxy0     | mysql | 172.25.0.15 | 3306 | W    |      0 |    0 | 1000 |       0 |</span><br><span class="line">| dn11     | workstation0 | mysql | 172.25.0.10 | 3306 | R    |      0 |    3 | 1000 |       3 |</span><br><span class="line">| dn11     | workstation0 | mysql | 172.25.0.10 | 3306 | R    |      0 |    3 | 1000 |       3 |</span><br><span class="line">| dn1      | mastera0     | mysql | 172.25.0.11 | 3306 | W    |      0 |   10 | 1000 |      28 |</span><br><span class="line">| dn1      | masterb0     | mysql | 172.25.0.12 | 3306 | W    |      0 |    1 | 1000 |      18 |</span><br><span class="line">| dn1      | slavea0      | mysql | 172.25.0.13 | 3306 | W    |      0 |    1 | 1000 |      18 |</span><br><span class="line">| dn10     | slaveb0      | mysql | 172.25.0.14 | 3306 | W    |      0 |   10 | 1000 |      10 |</span><br><span class="line">| dn10     | dbproxy0     | mysql | 172.25.0.15 | 3306 | W    |      0 |    0 | 1000 |       0 |</span><br><span class="line">| dn10     | workstation0 | mysql | 172.25.0.10 | 3306 | R    |      0 |    3 | 1000 |       3 |</span><br><span class="line">| dn10     | workstation0 | mysql | 172.25.0.10 | 3306 | R    |      0 |    3 | 1000 |       3 |</span><br><span class="line">| dn3      | mastera0     | mysql | 172.25.0.11 | 3306 | W    |      0 |   10 | 1000 |      28 |</span><br><span class="line">| dn3      | masterb0     | mysql | 172.25.0.12 | 3306 | W    |      0 |    1 | 1000 |      18 |</span><br><span class="line">| dn3      | slavea0      | mysql | 172.25.0.13 | 3306 | W    |      0 |    1 | 1000 |      18 |</span><br><span class="line">| dn2      | mastera0     | mysql | 172.25.0.11 | 3306 | W    |      0 |   10 | 1000 |      28 |</span><br><span class="line">| dn2      | masterb0     | mysql | 172.25.0.12 | 3306 | W    |      0 |    1 | 1000 |      18 |</span><br><span class="line">| dn2      | slavea0      | mysql | 172.25.0.13 | 3306 | W    |      0 |    1 | 1000 |      18 |</span><br><span class="line">| dn5      | mastera0     | mysql | 172.25.0.11 | 3306 | W    |      0 |   10 | 1000 |      28 |</span><br><span class="line">| dn5      | masterb0     | mysql | 172.25.0.12 | 3306 | W    |      0 |    1 | 1000 |      18 |</span><br><span class="line">| dn5      | slavea0      | mysql | 172.25.0.13 | 3306 | W    |      0 |    1 | 1000 |      18 |</span><br><span class="line">| dn4      | mastera0     | mysql | 172.25.0.11 | 3306 | W    |      0 |   10 | 1000 |      28 |</span><br><span class="line">| dn4      | masterb0     | mysql | 172.25.0.12 | 3306 | W    |      0 |    1 | 1000 |      18 |</span><br><span class="line">| dn4      | slavea0      | mysql | 172.25.0.13 | 3306 | W    |      0 |    1 | 1000 |      18 |</span><br><span class="line">| dn7      | mastera0     | mysql | 172.25.0.11 | 3306 | W    |      0 |   10 | 1000 |      28 |</span><br><span class="line">| dn7      | masterb0     | mysql | 172.25.0.12 | 3306 | W    |      0 |    1 | 1000 |      18 |</span><br><span class="line">| dn7      | slavea0      | mysql | 172.25.0.13 | 3306 | W    |      0 |    1 | 1000 |      18 |</span><br><span class="line">| dn6      | mastera0     | mysql | 172.25.0.11 | 3306 | W    |      0 |   10 | 1000 |      28 |</span><br><span class="line">| dn6      | masterb0     | mysql | 172.25.0.12 | 3306 | W    |      0 |    1 | 1000 |      18 |</span><br><span class="line">| dn6      | slavea0      | mysql | 172.25.0.13 | 3306 | W    |      0 |    1 | 1000 |      18 |</span><br><span class="line">| dn9      | slaveb0      | mysql | 172.25.0.14 | 3306 | W    |      0 |   10 | 1000 |      10 |</span><br><span class="line">| dn9      | dbproxy0     | mysql | 172.25.0.15 | 3306 | W    |      0 |    0 | 1000 |       0 |</span><br><span class="line">| dn9      | workstation0 | mysql | 172.25.0.10 | 3306 | R    |      0 |    3 | 1000 |       3 |</span><br><span class="line">| dn9      | workstation0 | mysql | 172.25.0.10 | 3306 | R    |      0 |    3 | 1000 |       3 |</span><br><span class="line">| dn8      | mastera0     | mysql | 172.25.0.11 | 3306 | W    |      0 |   10 | 1000 |      28 |</span><br><span class="line">| dn8      | masterb0     | mysql | 172.25.0.12 | 3306 | W    |      0 |    1 | 1000 |      18 |</span><br><span class="line">| dn8      | slavea0      | mysql | 172.25.0.13 | 3306 | W    |      0 |    1 | 1000 |      18 |</span><br><span class="line">+----------+--------------+-------+-------------+------+------+--------+------+------+---------+</span><br></pre></td></tr></tbody></table></figure>

<h2 id="7-HAproxy实现MyCat负载均衡" class="article-heading"><a href="#7-HAproxy实现MyCat负载均衡" class="headerlink" title="7 HAproxy实现MyCat负载均衡"></a>7 HAproxy实现MyCat负载均衡<a class="article-anchor" href="#7-HAproxy实现MyCat负载均衡" aria-hidden="true"></a></h2><h3 id="7-1-软件安装" class="article-heading"><a href="#7-1-软件安装" class="headerlink" title="7.1 软件安装"></a>7.1 软件安装<a class="article-anchor" href="#7-1-软件安装" aria-hidden="true"></a></h3><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">yum install -y haproxy</span><br></pre></td></tr></tbody></table></figure>

<h3 id="7-2-配置文件" class="article-heading"><a href="#7-2-配置文件" class="headerlink" title="7.2 配置文件"></a>7.2 配置文件<a class="article-anchor" href="#7-2-配置文件" aria-hidden="true"></a></h3><ul>
<li>haproxy管理端口：8888</li>
<li>代理mycat数据端口：7066</li>
</ul>
<h4 id="7-2-1-haproxy-01" class="article-heading"><a href="#7-2-1-haproxy-01" class="headerlink" title="7.2.1 haproxy_01"></a>7.2.1 haproxy_01<a class="article-anchor" href="#7-2-1-haproxy-01" aria-hidden="true"></a></h4><p>编辑/etc/haproxy/haproxy.cfg 文件</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">global</span><br><span class="line">	log 127.0.0.1 local0</span><br><span class="line">	log 127.0.0.1 local1 notice</span><br><span class="line">	maxconn 4096</span><br><span class="line">	daemon</span><br><span class="line">	nbproc 1</span><br><span class="line">	user haproxy</span><br><span class="line">	group haproxy</span><br><span class="line">defaults</span><br><span class="line">	log global</span><br><span class="line">	mode http</span><br><span class="line">	option httplog</span><br><span class="line">	option dontlognull</span><br><span class="line">	retries 3</span><br><span class="line">	option redispatch</span><br><span class="line">	maxconn 2100</span><br><span class="line">	timeout connect 5000</span><br><span class="line">	timeout client 50000</span><br><span class="line">	timeout server 50000</span><br><span class="line">listen admin_stats 172.25.0.15:8888 # localhost</span><br><span class="line">	option httplog</span><br><span class="line">	stats enable</span><br><span class="line">	stats refresh 30s</span><br><span class="line">	stats uri /stats</span><br><span class="line">	stats realm Haproxy Manager</span><br><span class="line">	stats auth admin:admin</span><br><span class="line">listen mycat_proxy 172.25.0.100:7066 #vip</span><br><span class="line">	mode tcp</span><br><span class="line">	balance roundrobin</span><br><span class="line">	option tcplog</span><br><span class="line">	option httpchk</span><br><span class="line">  	server mycat_1 172.25.0.15:8066 weight 1</span><br><span class="line">    server  mycat_2 172.25.0.10:8066 weight 1</span><br></pre></td></tr></tbody></table></figure>

<h4 id="7-2-2-haproxy-02" class="article-heading"><a href="#7-2-2-haproxy-02" class="headerlink" title="7.2.2 haproxy_02"></a>7.2.2 haproxy_02<a class="article-anchor" href="#7-2-2-haproxy-02" aria-hidden="true"></a></h4><p>编辑/etc/haproxy/haproxy.cfg 文件</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">global</span><br><span class="line">	log 127.0.0.1 local0</span><br><span class="line">	log 127.0.0.1 local1 notice</span><br><span class="line">	maxconn 4096</span><br><span class="line">	daemon</span><br><span class="line">	nbproc 1</span><br><span class="line">	user haproxy</span><br><span class="line">	group haproxy</span><br><span class="line">defaults</span><br><span class="line">	log global</span><br><span class="line">	mode http</span><br><span class="line">	option httplog</span><br><span class="line">	option dontlognull</span><br><span class="line">	retries 3</span><br><span class="line">	option redispatch</span><br><span class="line">	maxconn 2100</span><br><span class="line">	timeout connect 5000</span><br><span class="line">	timeout client 50000</span><br><span class="line">	timeout server 50000</span><br><span class="line">listen admin_stats 172.25.0.10:8888 #localhost</span><br><span class="line">	option httplog</span><br><span class="line">	stats enable</span><br><span class="line">	stats refresh 30s</span><br><span class="line">	stats uri /stats</span><br><span class="line">	stats realm Haproxy Manager</span><br><span class="line">	stats auth admin:admin</span><br><span class="line">listen mycat_proxy 172.25.0.100:7066 #vip</span><br><span class="line">	mode tcp</span><br><span class="line">	balance roundrobin</span><br><span class="line">	option tcplog</span><br><span class="line">	option httpchk</span><br><span class="line">  	server mycat_1 172.25.0.15:8066 weight 1</span><br><span class="line">      	server  mycat_2 172.25.0.10:8066 weight 1</span><br></pre></td></tr></tbody></table></figure>

<h2 id="8-keepalived实现Haproxy高可用" class="article-heading"><a href="#8-keepalived实现Haproxy高可用" class="headerlink" title="8 keepalived实现Haproxy高可用"></a>8 keepalived实现Haproxy高可用<a class="article-anchor" href="#8-keepalived实现Haproxy高可用" aria-hidden="true"></a></h2><h3 id="8-1-软件安装" class="article-heading"><a href="#8-1-软件安装" class="headerlink" title="8.1 软件安装"></a>8.1 软件安装<a class="article-anchor" href="#8-1-软件安装" aria-hidden="true"></a></h3><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">yum install -y keepalived</span><br></pre></td></tr></tbody></table></figure>

<h3 id="8-2-配置文件" class="article-heading"><a href="#8-2-配置文件" class="headerlink" title="8.2 配置文件"></a>8.2 配置文件<a class="article-anchor" href="#8-2-配置文件" aria-hidden="true"></a></h3><p>vip地址：172.25.0.100</p>
<p>默认主为keepalived_01，备为keepalived_02</p>
<h4 id="8-2-1-keepalived-01" class="article-heading"><a href="#8-2-1-keepalived-01" class="headerlink" title="8.2.1 keepalived_01"></a>8.2.1 keepalived_01<a class="article-anchor" href="#8-2-1-keepalived-01" aria-hidden="true"></a></h4><p>修改/etc/keepalived/keepalived.conf 设置为<code>state MASTER</code></p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs {</span><br><span class="line">   notification_email {</span><br><span class="line">     acassen@firewall.loc</span><br><span class="line">     failover@firewall.loc</span><br><span class="line">     sysadmin@firewall.loc</span><br><span class="line">   }</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">   smtp_server 172.25.0.15</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   vrrp_strict</span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 {</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication {</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    }</span><br><span class="line">    virtual_ipaddress {</span><br><span class="line">        172.25.0.100</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="8-2-2-keepalived-02" class="article-heading"><a href="#8-2-2-keepalived-02" class="headerlink" title="8.2.2 keepalived_02"></a>8.2.2 keepalived_02<a class="article-anchor" href="#8-2-2-keepalived-02" aria-hidden="true"></a></h4><p>修改/etc/keepalived/keepalived.conf ，设置为<code>state BACK</code></p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs {</span><br><span class="line">   notification_email {</span><br><span class="line">     acassen@firewall.loc</span><br><span class="line">     failover@firewall.loc</span><br><span class="line">     sysadmin@firewall.loc</span><br><span class="line">   }</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">   smtp_server 172.25.0.10</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   vrrp_strict</span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 {</span><br><span class="line">    state BACK</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 30</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication {</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    }</span><br><span class="line">    virtual_ipaddress {</span><br><span class="line">        172.25.0.100</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="8-3-启动服务" class="article-heading"><a href="#8-3-启动服务" class="headerlink" title="8.3 启动服务"></a>8.3 启动服务<a class="article-anchor" href="#8-3-启动服务" aria-hidden="true"></a></h3><h4 id="8-3-1-keepalived-01" class="article-heading"><a href="#8-3-1-keepalived-01" class="headerlink" title="8.3.1 keepalived_01"></a>8.3.1 keepalived_01<a class="article-anchor" href="#8-3-1-keepalived-01" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">systemctl start keepalived</span><br></pre></td></tr></tbody></table></figure>

<h4 id="8-3-2-keepalived-02" class="article-heading"><a href="#8-3-2-keepalived-02" class="headerlink" title="8.3.2 keepalived_02"></a>8.3.2 keepalived_02<a class="article-anchor" href="#8-3-2-keepalived-02" aria-hidden="true"></a></h4><figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">systemctl start keepalived</span><br></pre></td></tr></tbody></table></figure>

<h3 id="8-4-验证结果" class="article-heading"><a href="#8-4-验证结果" class="headerlink" title="8.4 验证结果"></a>8.4 验证结果<a class="article-anchor" href="#8-4-验证结果" aria-hidden="true"></a></h3><h4 id="8-4-1-keepalived-01" class="article-heading"><a href="#8-4-1-keepalived-01" class="headerlink" title="8.4.1 keepalived_01"></a>8.4.1 keepalived_01<a class="article-anchor" href="#8-4-1-keepalived-01" aria-hidden="true"></a></h4><p>查看vip执行<code>ip a</code></p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 52:54:00:00:00:0f brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.25.0.15/24 brd 172.25.0.255 scope global dynamic eth0</span><br><span class="line">       valid_lft 20814sec preferred_lft 20814sec</span><br><span class="line">    inet 172.25.0.100/32 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::5054:ff:fe00:f/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 52:54:00:01:00:0f brd ff:ff:ff:ff:ff:ff</span><br></pre></td></tr></tbody></table></figure>

<h4 id="8-4-1-keepalived-02" class="article-heading"><a href="#8-4-1-keepalived-02" class="headerlink" title="8.4.1 keepalived_02"></a>8.4.1 keepalived_02<a class="article-anchor" href="#8-4-1-keepalived-02" aria-hidden="true"></a></h4><p>查看ip,执行<code>ip a</code></p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 52:54:00:00:00:0a brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.25.0.10/24 brd 172.25.0.255 scope global dynamic eth0</span><br><span class="line">       valid_lft 19769sec preferred_lft 19769sec</span><br><span class="line">    inet6 fe80::5054:ff:fe00:a/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 52:54:00:01:00:0a brd ff:ff:ff:ff:ff:ff</span><br><span class="line">4: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN</span><br><span class="line">    link/ether 52:54:00:4c:2e:ea brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">5: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc pfifo_fast master virbr0 state DOWN qlen 500</span><br><span class="line">    link/ether 52:54:00:4c:2e:ea brd ff:ff:ff:ff:ff:ff</span><br></pre></td></tr></tbody></table></figure>

<p>可以看到keepalived_01的eth0下由两个ip，一个是172.25.0.15，一个是72.25.0.100，到此说明keepalived配置成功。</p>
<h2 id="9-启动HAproxy" class="article-heading"><a href="#9-启动HAproxy" class="headerlink" title="9 启动HAproxy"></a>9 启动HAproxy<a class="article-anchor" href="#9-启动HAproxy" aria-hidden="true"></a></h2><p>注意：只能在keepalived主上面启动HAproxy，即172.25.0.100上。</p>
<h3 id="9-1-启动服务" class="article-heading"><a href="#9-1-启动服务" class="headerlink" title="9.1 启动服务"></a>9.1 启动服务<a class="article-anchor" href="#9-1-启动服务" aria-hidden="true"></a></h3><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">systemctl start haproxy</span><br></pre></td></tr></tbody></table></figure>

<h3 id="9-2-查看服务状态" class="article-heading"><a href="#9-2-查看服务状态" class="headerlink" title="9.2 查看服务状态"></a>9.2 查看服务状态<a class="article-anchor" href="#9-2-查看服务状态" aria-hidden="true"></a></h3><p>执行命令<code>systemctl status haproxy</code>，执行结果：</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">● haproxy.service - HAProxy Load Balancer</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/haproxy.service; disabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Thu 2018-02-08 16:08:50 CST; 21s ago</span><br><span class="line"> Main PID: 18504 (haproxy-systemd)</span><br><span class="line">   CGroup: /system.slice/haproxy.service</span><br><span class="line">           ├─18504 /usr/sbin/haproxy-systemd-wrapper -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid</span><br><span class="line">           ├─18505 /usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid -Ds</span><br><span class="line">           └─18506 /usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid -Ds</span><br><span class="line"></span><br><span class="line">Feb 08 16:08:50 dbproxy0.example.com systemd[1]: Started HAProxy Load Balancer.</span><br><span class="line">Feb 08 16:08:50 dbproxy0.example.com systemd[1]: Starting HAProxy Load Balancer...</span><br><span class="line">Feb 08 16:08:50 dbproxy0.example.com haproxy-systemd-wrapper[18504]: haproxy-systemd-wrapper: executing /usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid -Ds</span><br></pre></td></tr></tbody></table></figure>

<h3 id="9-3-查看haproxy监听端口" class="article-heading"><a href="#9-3-查看haproxy监听端口" class="headerlink" title="9.3 查看haproxy监听端口"></a>9.3 查看haproxy监听端口<a class="article-anchor" href="#9-3-查看haproxy监听端口" aria-hidden="true"></a></h3><p>执行命令<code>ss -luntp|grep haproxy</code>，执行结果：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">udp    UNCONN     0      0         *:43585                 *:*                   users:(("haproxy",pid=18506,fd=5),("haproxy",pid=18505,fd=5))</span><br><span class="line">tcp    LISTEN     0      128    172.25.0.15:8888                  *:*                   users:(("haproxy",pid=18506,fd=4))</span><br><span class="line">tcp    LISTEN     0      128    172.25.0.100:7066                  *:*                   users:(("haproxy",pid=18506,fd=6))</span><br></pre></td></tr></tbody></table></figure>

<h1 id="10-测试整体架构" class="article-heading"><a href="#10-测试整体架构" class="headerlink" title="10 测试整体架构"></a>10 测试整体架构<a class="article-anchor" href="#10-测试整体架构" aria-hidden="true"></a></h1><h3 id="10-1-测试分片" class="article-heading"><a href="#10-1-测试分片" class="headerlink" title="10.1 测试分片"></a>10.1 测试分片<a class="article-anchor" href="#10-1-测试分片" aria-hidden="true"></a></h3><h4 id="10-1-1-测试思路" class="article-heading"><a href="#10-1-1-测试思路" class="headerlink" title="10.1.1 测试思路"></a>10.1.1 测试思路<a class="article-anchor" href="#10-1-1-测试思路" aria-hidden="true"></a></h4><p>根据mycat配置中分片规则，以下记录将会分别存入不同的后端实例中，具体如表格：</p>
<table>
<thead>
<tr>
<th>分片键</th>
<th>范围</th>
<th>节点</th>
<th>集群</th>
<th>物理库表</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>0-10000</td>
<td>0</td>
<td>pxc</td>
<td>db2_01.t2</td>
</tr>
<tr>
<td>id</td>
<td>10000-20000</td>
<td>1</td>
<td>pxc</td>
<td>db2_02.t2</td>
</tr>
<tr>
<td>id</td>
<td>20000-30000</td>
<td>2</td>
<td>pxc</td>
<td>db2_03.t2</td>
</tr>
<tr>
<td>id</td>
<td>30000-40000</td>
<td>3</td>
<td>pxc</td>
<td>db2_04.t2</td>
</tr>
<tr>
<td>id</td>
<td>40000-50000</td>
<td>4</td>
<td>pxc</td>
<td>db2_05.t2</td>
</tr>
<tr>
<td>id</td>
<td>50000-60000</td>
<td>5</td>
<td>pxc</td>
<td>db2_06.t2</td>
</tr>
<tr>
<td>id</td>
<td>60000-70000</td>
<td>6</td>
<td>pxc</td>
<td>db2_07.t2</td>
</tr>
<tr>
<td>id</td>
<td>70000-80000</td>
<td>7</td>
<td>pxc</td>
<td>db2_08.t2</td>
</tr>
<tr>
<td>id</td>
<td>80000-90000</td>
<td>8</td>
<td>mms</td>
<td>db2_01.t2</td>
</tr>
<tr>
<td>id</td>
<td>90000-100000</td>
<td>9</td>
<td>mms</td>
<td>db2_02.t2</td>
</tr>
<tr>
<td>id</td>
<td>100000-110000</td>
<td>10</td>
<td>mms</td>
<td>db2_03.t2</td>
</tr>
<tr>
<td>id</td>
<td>110000-120000</td>
<td>11</td>
<td>mms</td>
<td>db2_04.t2</td>
</tr>
<tr>
<td>id</td>
<td>120000-130000</td>
<td>12</td>
<td>mms</td>
<td>db2_05.t2</td>
</tr>
<tr>
<td>id</td>
<td>130000-140000</td>
<td>13</td>
<td>mms</td>
<td>db2_06.t2</td>
</tr>
<tr>
<td>id</td>
<td>140000-150000</td>
<td>14</td>
<td>mms</td>
<td>db2_07.t2</td>
</tr>
<tr>
<td>id</td>
<td>150000-160000</td>
<td>15</td>
<td>mms</td>
<td>db2_08.t2</td>
</tr>
</tbody></table>
<p>执行插入语句：</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">insert into t2 (id,name) values (1,@@hostname);</span><br><span class="line">insert into t2 (id,name) values (80000,@@hostname);</span><br><span class="line">insert into t2 (id,name) values (160000,@@hostname);</span><br><span class="line">insert into t2 (id,name) values (150000000,@@hostname);</span><br></pre></td></tr></tbody></table></figure>

<p>到后端集群中取验证，是否如表中的规则，将对应的记录写如对应的物理节点。</p>
<h4 id="10-1-2-测试过程" class="article-heading"><a href="#10-1-2-测试过程" class="headerlink" title="10.1.2 测试过程"></a>10.1.2 测试过程<a class="article-anchor" href="#10-1-2-测试过程" aria-hidden="true"></a></h4><p>执行命令<code>mysql -uroot -puplooking -h172.25.0.100 -P 7066</code>连接vip，访问haproxy的7066端口来访问分布式数据库。</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 4</span><br><span class="line">Server version: 5.5.8-mycat-1.5.1-RELEASE-20160328130228 MyCat Server (OpenCloundDB)</span><br><span class="line">Copyright (c) 2009-2016 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2016, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line">Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看库</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">show databases;</span></span><br><span class="line">+----------+</span><br><span class="line">| DATABASE |</span><br><span class="line">+----------+</span><br><span class="line">| ecshop   |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用ecshop库</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">use ecshop;</span></span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line">Database changed</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看t2表的结构</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">desc t2;</span></span><br><span class="line">+-------+-------------+------+-----+---------+-------+</span><br><span class="line">| Field | Type        | Null | Key | Default | Extra |</span><br><span class="line">+-------+-------------+------+-----+---------+-------+</span><br><span class="line">| id    | int(11)     | NO   | PRI | NULL    |       |</span><br><span class="line">| name  | varchar(30) | YES  |     | NULL    |       |</span><br><span class="line">+-------+-------------+------+-----+---------+-------+</span><br><span class="line">2 rows in set (0.02 sec)</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">插入记录</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">insert into t2 (<span class="built_in">id</span>,name) values (1,@@hostname);</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">insert into t2 (<span class="built_in">id</span>,name) values (80000,@@hostname);</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">insert into t2 (<span class="built_in">id</span>,name) values (160000,@@hostname);</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">insert into t2 (<span class="built_in">id</span>,name) values (150000000,@@hostname);</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看t2表的数据</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash"><span class="keyword">select</span> * from t2;</span></span><br><span class="line">+-----------+----------------------+</span><br><span class="line">| id        | name                 |</span><br><span class="line">+-----------+----------------------+</span><br><span class="line">|         1 | mastera0.example.com |</span><br><span class="line">|     80000 | mastera0.example.com |</span><br><span class="line">| 150000000 | slaveb0.example.com  |</span><br><span class="line">|    160000 | slaveb0.example.com  |</span><br><span class="line">+-----------+----------------------+</span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash"><span class="keyword">select</span> * from t2 <span class="built_in">where</span> <span class="built_in">id</span>&gt;799;</span></span><br><span class="line">+-----------+----------------------+</span><br><span class="line">| id        | name                 |</span><br><span class="line">+-----------+----------------------+</span><br><span class="line">|    160000 | slaveb0.example.com  |</span><br><span class="line">|     80000 | mastera0.example.com |</span><br><span class="line">| 150000000 | slaveb0.example.com  |</span><br><span class="line">+-----------+----------------------+</span><br><span class="line">3 rows in set (0.03 sec)</span><br></pre></td></tr></tbody></table></figure>

<h4 id="10-1-3-测试结果" class="article-heading"><a href="#10-1-3-测试结果" class="headerlink" title="10.1.3 测试结果"></a>10.1.3 测试结果<a class="article-anchor" href="#10-1-3-测试结果" aria-hidden="true"></a></h4><h5 id="10-1-3-1-pxc" class="article-heading"><a href="#10-1-3-1-pxc" class="headerlink" title="10.1.3.1 pxc"></a>10.1.3.1 pxc<a class="article-anchor" href="#10-1-3-1-pxc" aria-hidden="true"></a></h5><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash"><span class="keyword">select</span> * from db2_01.t2;</span></span><br><span class="line">+----+----------------------+</span><br><span class="line">| id | name                 |</span><br><span class="line">+----+----------------------+</span><br><span class="line">|  1 | mastera0.example.com |</span><br><span class="line">+----+----------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash"><span class="keyword">select</span> * from db2_08.t2;</span></span><br><span class="line">+-------+----------------------+</span><br><span class="line">| id    | name                 |</span><br><span class="line">+-------+----------------------+</span><br><span class="line">| 80000 | mastera0.example.com |</span><br><span class="line">+-------+----------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></tbody></table></figure>

<h5 id="10-1-3-2-mms" class="article-heading"><a href="#10-1-3-2-mms" class="headerlink" title="10.1.3.2 mms"></a>10.1.3.2 mms<a class="article-anchor" href="#10-1-3-2-mms" aria-hidden="true"></a></h5><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash"><span class="keyword">select</span> * from db2_01.t2;</span></span><br><span class="line">+-----------+---------------------+</span><br><span class="line">| id        | name                |</span><br><span class="line">+-----------+---------------------+</span><br><span class="line">| 150000000 | slaveb0.example.com |</span><br><span class="line">+-----------+---------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash"><span class="keyword">select</span> * from db2_08.t2;</span></span><br><span class="line">+--------+---------------------+</span><br><span class="line">| id     | name                |</span><br><span class="line">+--------+---------------------+</span><br><span class="line">| 160000 | slaveb0.example.com |</span><br><span class="line">+--------+---------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></tbody></table></figure>

<p>验证成功！</p>
<table>
<thead>
<tr>
<th>id</th>
<th>节点</th>
<th>集群</th>
<th>物理库表</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>0</td>
<td>pxc</td>
<td>db2_01.t2</td>
</tr>
<tr>
<td>80000</td>
<td>7</td>
<td>pxc</td>
<td>db2_08.t2</td>
</tr>
<tr>
<td>160000</td>
<td>15</td>
<td>mms</td>
<td>db2_08.t2</td>
</tr>
<tr>
<td>150000000</td>
<td>8</td>
<td>mm</td>
<td>db2_01.t2</td>
</tr>
</tbody></table>
<p>注意：超出规则的，则按照默认节点进行分片，配置中设置的默认分片节点为8号节点。可以看[6.2.5 rule.xml](#### 6.2.5 rule.xml)</p>
<h3 id="10-2-测试整体架构的高可用HA" class="article-heading"><a href="#10-2-测试整体架构的高可用HA" class="headerlink" title="10.2 测试整体架构的高可用HA"></a>10.2 测试整体架构的高可用HA<a class="article-anchor" href="#10-2-测试整体架构的高可用HA" aria-hidden="true"></a></h3><h4 id="10-2-1-模拟客户端访问" class="article-heading"><a href="#10-2-1-模拟客户端访问" class="headerlink" title="10.2.1 模拟客户端访问"></a>10.2.1 模拟客户端访问<a class="article-anchor" href="#10-2-1-模拟客户端访问" aria-hidden="true"></a></h4><p>执行命令<code>mysql -uroot -puplooking -h172.25.0.100 -P 7066</code>连接vip，访问haproxy的7066端口来访问分布式数据库。</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 4</span><br><span class="line">Server version: 5.5.8-mycat-1.5.1-RELEASE-20160328130228 MyCat Server (OpenCloundDB)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2016 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2016, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">use ecshop;</span></span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash"><span class="keyword">select</span> * from t2 <span class="built_in">where</span> <span class="built_in">id</span>&gt;1;</span></span><br><span class="line">+-----------+----------------------+</span><br><span class="line">| id        | name                 |</span><br><span class="line">+-----------+----------------------+</span><br><span class="line">|     80000 | mastera0.example.com |</span><br><span class="line">|    160000 | slaveb0.example.com  |</span><br><span class="line">| 150000000 | slaveb0.example.com  |</span><br><span class="line">+-----------+----------------------+</span><br><span class="line">3 rows in set (0.02 sec)</span><br></pre></td></tr></tbody></table></figure>

<h4 id="10-2-2-模拟haproxy-01宕掉" class="article-heading"><a href="#10-2-2-模拟haproxy-01宕掉" class="headerlink" title="10.2.2 模拟haproxy_01宕掉"></a>10.2.2 模拟haproxy_01宕掉<a class="article-anchor" href="#10-2-2-模拟haproxy-01宕掉" aria-hidden="true"></a></h4><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">systemctl stop haproxy</span><br></pre></td></tr></tbody></table></figure>

<p>此时客户端访问已经报错</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash"><span class="keyword">select</span> * from t2 <span class="built_in">where</span> <span class="built_in">id</span>&gt;1;</span></span><br><span class="line">ERROR 2013 (HY000): Lost connection to MySQL server during query</span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash"><span class="keyword">select</span> * from t2 <span class="built_in">where</span> <span class="built_in">id</span>&gt;1;</span></span><br><span class="line">ERROR 2006 (HY000): MySQL server has gone away</span><br><span class="line">No connection. Trying to reconnect...</span><br><span class="line">ERROR 2003 (HY000): Can't connect to MySQL server on '172.25.0.100' (111)</span><br><span class="line">ERROR:</span><br><span class="line">Can't connect to the server</span><br></pre></td></tr></tbody></table></figure>

<p>启动haproxy_02上的服务</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">systemctl start haproxy</span><br></pre></td></tr></tbody></table></figure>

<p>正常情况下如果是软件故障直接重启即可恢复；如果是硬件故障，则vip会自动跳到haproxy_02，此时Haporxy就能正常启动。而我的测试环境中没有将vip跳转，所以haproxy02服务无法启动。</p>
<p>启动haproxy_01</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">systemctl start haproxy</span><br></pre></td></tr></tbody></table></figure>

<p>客户端访问正常</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">mysql&gt; select * from t2 where id&gt;1;</span><br><span class="line">+-----------+----------------------+</span><br><span class="line">| id        | name                 |</span><br><span class="line">+-----------+----------------------+</span><br><span class="line">|     80000 | mastera0.example.com |</span><br><span class="line">|    160000 | slaveb0.example.com  |</span><br><span class="line">| 150000000 | slaveb0.example.com  |</span><br><span class="line">+-----------+----------------------+</span><br><span class="line">3 rows in set (0.02 sec)</span><br></pre></td></tr></tbody></table></figure>

<h4 id="10-2-3-模拟mycat-01宕机" class="article-heading"><a href="#10-2-3-模拟mycat-01宕机" class="headerlink" title="10.2.3 模拟mycat_01宕机"></a>10.2.3 模拟mycat_01宕机<a class="article-anchor" href="#10-2-3-模拟mycat-01宕机" aria-hidden="true"></a></h4><p>在mycat_01上执行<code>mycat stop</code>,输出如下：</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">Stopping Mycat-server...</span><br><span class="line">Mycat-server was not running.</span><br></pre></td></tr></tbody></table></figure>

<p>客户端访问正常：</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash"><span class="keyword">select</span> * from t2 <span class="built_in">where</span> <span class="built_in">id</span>&gt;1;</span></span><br><span class="line">+-----------+----------------------+</span><br><span class="line">| id        | name                 |</span><br><span class="line">+-----------+----------------------+</span><br><span class="line">|     80000 | mastera0.example.com |</span><br><span class="line">|    160000 | slaveb0.example.com  |</span><br><span class="line">| 150000000 | slaveb0.example.com  |</span><br><span class="line">+-----------+----------------------+</span><br><span class="line">3 rows in set (0.02 sec)</span><br></pre></td></tr></tbody></table></figure>

<h4 id="10-2-4-模拟pxc-node1宕机" class="article-heading"><a href="#10-2-4-模拟pxc-node1宕机" class="headerlink" title="10.2.4 模拟pxc_node1宕机"></a>10.2.4 模拟pxc_node1宕机<a class="article-anchor" href="#10-2-4-模拟pxc-node1宕机" aria-hidden="true"></a></h4><p>在pxc_node1上执行</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">systemctl stop mysql</span><br></pre></td></tr></tbody></table></figure>

<p>客户端访问正常：</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash"><span class="keyword">select</span> * from t2 <span class="built_in">where</span> <span class="built_in">id</span>&gt;1;</span></span><br><span class="line">+-----------+----------------------+</span><br><span class="line">| id        | name                 |</span><br><span class="line">+-----------+----------------------+</span><br><span class="line">|     80000 | mastera0.example.com |</span><br><span class="line">|    160000 | slaveb0.example.com  |</span><br><span class="line">| 150000000 | slaveb0.example.com  |</span><br><span class="line">+-----------+----------------------+</span><br><span class="line">3 rows in set (0.02 sec)</span><br></pre></td></tr></tbody></table></figure>

<p>在重启pxc_node1之前，需要先修改配置文件中的集群节点ip，因为集群搭建时pxc_node1是作为集群初始节点。</p>
<p>执行<code>vim /etc/my.cnf</code></p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">wsrep_cluster_address="gcomm://172.25.0.12"</span><br></pre></td></tr></tbody></table></figure>

<p>启动mysql服务<code>systemctl start mysql</code></p>
<p>查看集群状态<code>mysql -uroot -p'(Uploo00king)' -e "show global status like 'wsrep_cluster%'"</code></p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">+--------------------------+--------------------------------------+</span><br><span class="line">| Variable_name            | Value                                |</span><br><span class="line">+--------------------------+--------------------------------------+</span><br><span class="line">| wsrep_cluster_conf_id    | 23                                   |</span><br><span class="line">| wsrep_cluster_size       | 3                                    |</span><br><span class="line">| wsrep_cluster_state_uuid | 838b888e-0c95-11e8-9eaf-62dad1baf837 |</span><br><span class="line">| wsrep_cluster_status     | Primary                              |</span><br><span class="line">+--------------------------+--------------------------------------+</span><br></pre></td></tr></tbody></table></figure>

<h3 id="10-3-总结" class="article-heading"><a href="#10-3-总结" class="headerlink" title="10.3 总结"></a>10.3 总结<a class="article-anchor" href="#10-3-总结" aria-hidden="true"></a></h3><p>整个基于MyCat的数据库分布式架构中，没有一个服务存在单点故障，实现了很高的HA。</p>
<h2 id="参考文档" class="article-heading"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档<a class="article-anchor" href="#参考文档" aria-hidden="true"></a></h2><p><a target="_blank" rel="noopener" href="http://www.mycat.io/">MyCat官网 http://www.mycat.io/</a></p>
<p><a target="_blank" rel="noopener" href="http://www.haproxy.org/">HAproxy官网 http://www.haproxy.org/</a></p>
<p><a target="_blank" rel="noopener" href="http://www.keepalived.org/">Keepalived官网 http://www.keepalived.org/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.percona.com/">Percona官网 https://www.percona.com/</a></p>
</body></html>
              </div>
              <footer class="article-footer">
                <time class="article-footer-updated" datetime="2025-10-22T08:49:11.780Z" itemprop="dateModified">Last updated: 2025-10-22</time>
                <a href="/database/mysql/index.html" class="article-footer-next" title="概览"><span>Next</span><i class="fa fa-chevron-right"></i></a>
              </footer>
              
            </div>
          </div>
          <aside id="article-toc" role="navigation">
            <div id="article-toc-inner">
              <div id="carbonads" class="carbonads" style="text-align:center;font-family:'Noto Sans SC',sans-serif;">
  <span class="carbon-wrap">
    <a href="https://github.com/booboowei"
       class="carbon-img"
       target="_blank"
       rel="noopener sponsored">
      <img
        src="https://avatars2.githubusercontent.com/u/21328020?s=460&u=88cf6127c32932188f936d05636b7b0d36783ee1&v=4"
        alt="ads via Carbon"
        border="0"
        style="width:80px;height:80px;border-radius:50%;max-width:130px;"
      />
    </a>
    <a href="/about/"
       class="carbon-text"
       target="_blank"
       rel="noopener sponsored"
       style="display:block;margin-top:4px;">
      欢迎光临
    </a>
  </span>

  <!-- 日期显示 -->
  <div id="today-date" style="margin-top:12px;background:#f5f5f5;border-radius:12px;padding:10px 0;">
    <div id="weekday" style="font-size:14px;color:#555;"></div>
    <div id="day" style="font-size:36px;font-weight:bold;color:#000;"></div>
    <div id="ym" style="font-size:14px;color:#555;"></div>
    <div id="lunar" style="font-size:13px;color:#888;margin-top:4px;"></div>
  </div>

<script>
(function(){
  const now = new Date();
  const weekdays = ["星期日","星期一","星期二","星期三","星期四","星期五","星期六"];
  const year = now.getFullYear();
  const month = now.getMonth() + 1;
  const day = now.getDate();

  function toChineseNumber(num) {
    const map = {0:'〇',1:'一',2:'二',3:'三',4:'四',5:'五',6:'六',7:'七',8:'八',9:'九'};
    return String(num).split('').map(n=>map[n]).join('');
  }

  // 优先使用 Intl (现代浏览器支持农历/中国传统历)
  function getLunarByIntl(date) {
    try {
      // 获取农历的月（长格式，如 "九月" 或 "闰八月"），和日（数字）
      const monthFormatter = new Intl.DateTimeFormat('zh-CN-u-ca-chinese', { month: 'long' });
      const dayFormatter = new Intl.DateTimeFormat('zh-CN-u-ca-chinese', { day: 'numeric' });
      const lunarMonthText = monthFormatter.format(date); // 例如 "九月" 或 "闰八月"
      const lunarDayText = dayFormatter.format(date);     // 例如 "三十" 或 "初一"
      // 有的浏览器返回的 month 会包含 "闰" 字样，也可能返回汉字月份，需要适配
      return `农历${lunarMonthText}${lunarDayText}`;
    } catch (e) {
      return null; // 表示不支持 Intl 农历
    }
  }

  // 回退：简易本地农历算法（仅作兼容，适用于1900-2049范围）
  const lunarInfo = [0x04bd8,0x04ae0,0x0a570,0x054d5,0x0d260,0x0d950,0x16554,0x056a0,0x09ad0,0x055d2,
                     0x04ae0,0x0a5b6,0x0a4d0,0x0d250,0x1d255,0x0b540,0x0d6a0,0x0ada2,0x095b0,0x14977,
                     0x04970,0x0a4b0,0x0b4b5,0x06a50,0x06d40,0x1ab54,0x02b60,0x09570,0x052f2,0x04970,
                     0x06566,0x0d4a0,0x0ea50,0x06e95,0x05ad0,0x02b60,0x186e3,0x092e0,0x1c8d7,0x0c950,
                     0x0d4a0,0x1d8a6,0x0b550,0x056a0,0x1a5b4,0x025d0,0x092d0,0x0d2b2,0x0a950,0x0b557,
                     0x06ca0,0x0b550,0x15355,0x04da0,0x0a5b0,0x14573,0x052b0,0x0a9a8,0x0e950,0x06aa0,
                     0x0aea6,0x0ab50,0x04b60,0x0aae4,0x0a570,0x05260,0x0f263,0x0d950,0x05b57,0x056a0,
                     0x096d0,0x04dd5,0x04ad0,0x0a4d0,0x0d4d4,0x0d250,0x0d558,0x0b540,0x0b5a0,0x195a6,
                     0x095b0,0x049b0,0x0a974,0x0a4b0,0x0b27a,0x06a50,0x06d40,0x0af46,0x0ab60,0x09570,
                     0x04af5,0x04970,0x064b0,0x074a3,0x0ea50,0x06b58,0x05ac0,0x0ab60,0x096d5,0x092e0];

  function lYearDays(y){let i,sum=348;for(i=0x8000;i>0x8;i>>=1)sum+=(lunarInfo[y-1900]&i)?1:0;return sum+leapDays(y);}
  function leapDays(y){if(leapMonth(y))return(lunarInfo[y-1900]&0x10000)?30:29;else return 0;}
  function leapMonth(y){return lunarInfo[y-1900]&0xf;}
  function monthDays(y,m){return(lunarInfo[y-1900]&(0x10000>>m))?30:29;}

  function LunarFallback(objDate){
    let i, leap=0, temp=0;
    const baseDate = new Date(1900,0,31);
    let offset = Math.floor((objDate - baseDate) / 86400000);
    let year = 1900;
    // 年循环
    for (i = 1900; i < 2050 && offset > 0; i++) {
      temp = lYearDays(i);
      offset -= temp;
      year = i;
    }
    if (offset < 0) { offset += temp; year--; }
    leap = leapMonth(year);
    let isLeap = false;
    let month = 1;
    // 月循环
    for (i = 1; i <= 12 && offset > 0; i++) {
      if (leap > 0 && i === (leap + 1) && !isLeap) {
        // 进入闰月
        temp = leapDays(year);
        isLeap = true;
        i--; // stay on same month number but mark leap
      } else {
        temp = monthDays(year, i);
      }
      offset -= temp;
      if (isLeap && i === leap) { isLeap = false; }
      if (!isLeap) month++; // 非闰月时才推进月份计数
    }
    if (offset === 0 && leap > 0 && month === leap + 1) {
      // 特殊：当正好落在闰月第一天
      // month 保持，isLeap = true
    }
    if (offset < 0) { offset += temp; month--; }
    const day = offset + 1;
    // 修正 month 边界
    if (month <= 0) month = 1;
    return { year, month, day, isLeap: !!isLeap };
  }

  function getLunarDateStringFallback(y,m,d){
    const cDay=["","初一","初二","初三","初四","初五","初六","初七","初八","初九","初十",
                "十一","十二","十三","十四","十五","十六","十七","十八","十九","二十",
                "廿一","廿二","廿三","廿四","廿五","廿六","廿七","廿八","廿九","三十"];
    const cMon=["","正月","二月","三月","四月","五月","六月","七月","八月","九月","十月","冬月","腊月"];
    const lunar = LunarFallback(new Date(y, m-1, d));
    return `农历${lunar.isLeap ? '闰' : ''}${cMon[lunar.month]}${cDay[lunar.day]}`;
  }

  // 先尝试 Intl 方法
  let lunarText = getLunarByIntl(now);
  if (!lunarText) {
    // 回退本地算法
    lunarText = getLunarDateStringFallback(year, month, day);
  }

  // 输出到页面（公历 + 农历）
  document.getElementById("weekday").textContent = weekdays[now.getDay()];
  document.getElementById("day").textContent = day;
  document.getElementById("ym").textContent = `${toChineseNumber(year)}年${toChineseNumber(month)}月`;
  document.getElementById("lunar").textContent = lunarText;
})();
</script>


              <strong class="sidebar-title">Contents</strong>
              <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-text">1 架构图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%9C%8D%E5%8A%A1%E5%92%8C%E8%8A%82%E7%82%B9%E8%A7%84%E5%88%92"><span class="toc-text">2 服务和节点规划</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E8%BD%AF%E4%BB%B6%E5%87%86%E5%A4%87"><span class="toc-text">3 软件准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-PXC%E9%9B%86%E7%BE%A4%E7%9A%84%E6%90%AD%E5%BB%BA"><span class="toc-text">4 PXC集群的搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%AE%89%E8%A3%85%E8%BD%AF%E4%BB%B6"><span class="toc-text">4.1 安装软件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-pxc-node1"><span class="toc-text">4.2 pxc_node1</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-1-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">4.2.1 配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-2-%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="toc-text">4.4.2 启动服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-3-%E4%BF%AE%E6%94%B9%E5%88%9D%E5%A7%8B%E5%AF%86%E7%A0%81"><span class="toc-text">4.2.3 修改初始密码</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-3-1-%E5%AF%86%E7%A0%81%E4%BF%AE%E6%94%B9%E5%A4%B1%E8%B4%A5%E5%A4%84%E7%90%86"><span class="toc-text">4.2.3.1 密码修改失败处理</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-4-%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81"><span class="toc-text">4.2.4 查看集群状态</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-pxc-node2"><span class="toc-text">4.3 pxc_node2</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-1-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">4.3.1 配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-2-%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="toc-text">4.3.2 启动服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-3-%E4%BF%AE%E6%94%B9%E5%88%9D%E5%A7%8B%E5%AF%86%E7%A0%81"><span class="toc-text">4.3.3 修改初始密码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-4-%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81"><span class="toc-text">4.3.4 查看集群状态</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-pxc-node3"><span class="toc-text">4.4 pxc_node3</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-1-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">4.4.1 配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-2-%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1-1"><span class="toc-text">4.4.2 启动服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-3-%E4%BF%AE%E6%94%B9%E5%88%9D%E5%A7%8B%E5%AF%86%E7%A0%81"><span class="toc-text">4.4.3 修改初始密码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-4-%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81"><span class="toc-text">4.4.4 查看集群状态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-4-5-%E9%9B%86%E7%BE%A4%E5%AE%95%E6%9C%BA%E5%90%8E%E9%87%8D%E5%90%AF"><span class="toc-text">4.4.5 集群宕机后重启</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E9%AA%8C%E8%AF%81%E7%BB%93%E6%9E%9C"><span class="toc-text">4.5 验证结果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-MMS%E9%AB%98%E5%8F%AF%E7%94%A8%E6%90%AD%E5%BB%BA"><span class="toc-text">5 MMS高可用搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-mms-mastera"><span class="toc-text">5.1 mms_mastera</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-1-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">5.1.1 配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-2-%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="toc-text">5.1.2 启动服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-3-%E4%BF%AE%E6%94%B9%E5%88%9D%E5%A7%8B%E5%AF%86%E7%A0%81"><span class="toc-text">5.1.3 修改初始密码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-4-%E6%B7%BB%E5%8A%A0%E6%8E%88%E6%9D%83"><span class="toc-text">5.1.4 添加授权</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-5-%E6%9F%A5%E7%9C%8Bbinlog%E4%BD%8D%E7%BD%AE"><span class="toc-text">5.1.5 查看binlog位置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-mms-masterb"><span class="toc-text">5.2 mms_masterb</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-1-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">5.2.1 配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-2-%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="toc-text">5.2.2 启动服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-3-%E4%BF%AE%E6%94%B9%E5%88%9D%E5%A7%8B%E5%AF%86%E7%A0%81"><span class="toc-text">5.2.3 修改初始密码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-4-%E6%B7%BB%E5%8A%A0%E6%8E%88%E6%9D%83"><span class="toc-text">5.2.4 添加授权</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-5-%E5%AE%A3%E5%91%8A%E4%B8%BB%E5%BA%93"><span class="toc-text">5.2.5 宣告主库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-6-%E5%90%AF%E5%8A%A8%E4%BB%8E%E6%9C%8D%E5%8A%A1"><span class="toc-text">5.2.6 启动从服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-7-%E6%9F%A5%E7%9C%8B%E4%BB%8E%E6%9C%8D%E5%8A%A1%E7%8A%B6%E6%80%81"><span class="toc-text">5.2.7 查看从服务状态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-8-%E6%9F%A5%E7%9C%8Bbinlog%E4%BD%8D%E7%BD%AE"><span class="toc-text">5.2.8 查看binlog位置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-mms-slave"><span class="toc-text">5.3 mms_slave</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-1-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">5.3.1 配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-2-%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="toc-text">5.3.2 启动服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-3-%E4%BF%AE%E6%94%B9%E5%88%9D%E5%A7%8B%E5%AF%86%E7%A0%81"><span class="toc-text">5.3.3 修改初始密码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-4-%E5%AE%A3%E5%91%8A%E4%B8%BB%E5%BA%93"><span class="toc-text">5.3.4 宣告主库</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-mms-mastera"><span class="toc-text">5.4 mms_mastera</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-1-%E5%AE%A3%E5%91%8A%E4%B8%BB%E5%BA%93"><span class="toc-text">5.4.1 宣告主库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-2-%E5%90%AF%E5%8A%A8%E4%BB%8E%E6%9C%8D%E5%8A%A1"><span class="toc-text">5.4.2 启动从服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-3-%E6%9F%A5%E7%9C%8B%E4%BB%8E%E6%9C%8D%E5%8A%A1%E7%8A%B6%E6%80%81"><span class="toc-text">5.4.3 查看从服务状态</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-mms-slave"><span class="toc-text">5.5 mms_slave</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-5-2-%E5%90%AF%E5%8A%A8%E4%BB%8E%E6%9C%8D%E5%8A%A1"><span class="toc-text">5.5.2 启动从服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-5-3-%E6%9F%A5%E7%9C%8B%E4%BB%8E%E6%9C%8D%E5%8A%A1%E7%8A%B6%E6%80%81"><span class="toc-text">5.5.3 查看从服务状态</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-6-%E9%AA%8C%E8%AF%81%E7%BB%93%E6%9E%9C"><span class="toc-text">5.6 验证结果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-MyCAT%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E6%90%AD%E5%BB%BA"><span class="toc-text">6 MyCAT数据库中间件的搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85"><span class="toc-text">6.1 软件安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">6.2 配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-1-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%A6%82%E8%A7%88"><span class="toc-text">6.2.1 配置文件概览</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-2-%E9%85%8D%E7%BD%AE%E7%9B%AE%E6%A0%87"><span class="toc-text">6.2.2 配置目标</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#6-2-2-1-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8"><span class="toc-text">6.2.2.1 分库分表</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-2-2-2-%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="toc-text">6.2.2.2 读写分离</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-2-2-3-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">6.2.2.3 负载均衡</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-2-2-4-%E8%87%AA%E5%8A%A8%E6%95%85%E9%9A%9C%E8%BD%AC%E7%A7%BB"><span class="toc-text">6.2.2.4 自动故障转移</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-2-2-5-mycat%E8%BF%9E%E6%8E%A5mysql%E9%A9%B1%E5%8A%A8"><span class="toc-text">6.2.2.5 mycat连接mysql驱动</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-3-server-xml"><span class="toc-text">6.2.3 server.xml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-4-schema-xml"><span class="toc-text">6.2.4 schema.xml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-5-rule-xml"><span class="toc-text">6.2.5 rule.xml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-6-autopartition-long-txt"><span class="toc-text">6.2.6 autopartition-long.txt</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E4%BE%8B"><span class="toc-text">6.3 数据库实例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3-1-%E6%B7%BB%E5%8A%A0%E5%AF%B9mycat%E7%9A%84%E6%8E%88%E6%9D%83"><span class="toc-text">6.3.1 添加对mycat的授权</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3-2-%E5%BB%BA%E5%BA%93%E5%BB%BA%E8%A1%A8"><span class="toc-text">6.3.2 建库建表</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-%E5%90%AF%E5%8A%A8mycat%E6%9C%8D%E5%8A%A1"><span class="toc-text">6.4 启动mycat服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-4-1-%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="toc-text">6.4.1 启动服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-4-2-%E6%9F%A5%E7%9C%8B%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B"><span class="toc-text">6.4.2 查看守护进程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-4-3-%E6%9F%A5%E7%9C%8B%E7%9B%91%E5%90%AC"><span class="toc-text">6.4.3 查看监听</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-%E9%AA%8C%E8%AF%81%E7%BB%93%E6%9E%9C"><span class="toc-text">6.5 验证结果</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-5-1-%E9%AA%8C%E8%AF%81mycat-01"><span class="toc-text">6.5.1 验证mycat_01</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-5-2-%E9%AA%8C%E8%AF%81mycat-02"><span class="toc-text">6.5.2 验证mycat_02</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-HAproxy%E5%AE%9E%E7%8E%B0MyCat%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">7 HAproxy实现MyCat负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85"><span class="toc-text">7.1 软件安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">7.2 配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-1-haproxy-01"><span class="toc-text">7.2.1 haproxy_01</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-2-haproxy-02"><span class="toc-text">7.2.2 haproxy_02</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-keepalived%E5%AE%9E%E7%8E%B0Haproxy%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-text">8 keepalived实现Haproxy高可用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85"><span class="toc-text">8.1 软件安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">8.2 配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-2-1-keepalived-01"><span class="toc-text">8.2.1 keepalived_01</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-2-2-keepalived-02"><span class="toc-text">8.2.2 keepalived_02</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="toc-text">8.3 启动服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-3-1-keepalived-01"><span class="toc-text">8.3.1 keepalived_01</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-3-2-keepalived-02"><span class="toc-text">8.3.2 keepalived_02</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-4-%E9%AA%8C%E8%AF%81%E7%BB%93%E6%9E%9C"><span class="toc-text">8.4 验证结果</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-4-1-keepalived-01"><span class="toc-text">8.4.1 keepalived_01</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-4-1-keepalived-02"><span class="toc-text">8.4.1 keepalived_02</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E5%90%AF%E5%8A%A8HAproxy"><span class="toc-text">9 启动HAproxy</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="toc-text">9.1 启动服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-%E6%9F%A5%E7%9C%8B%E6%9C%8D%E5%8A%A1%E7%8A%B6%E6%80%81"><span class="toc-text">9.2 查看服务状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-3-%E6%9F%A5%E7%9C%8Bhaproxy%E7%9B%91%E5%90%AC%E7%AB%AF%E5%8F%A3"><span class="toc-text">9.3 查看haproxy监听端口</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10-%E6%B5%8B%E8%AF%95%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="toc-text">10 测试整体架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-1-%E6%B5%8B%E8%AF%95%E5%88%86%E7%89%87"><span class="toc-text">10.1 测试分片</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#10-1-1-%E6%B5%8B%E8%AF%95%E6%80%9D%E8%B7%AF"><span class="toc-text">10.1.1 测试思路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-1-2-%E6%B5%8B%E8%AF%95%E8%BF%87%E7%A8%8B"><span class="toc-text">10.1.2 测试过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-1-3-%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C"><span class="toc-text">10.1.3 测试结果</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#10-1-3-1-pxc"><span class="toc-text">10.1.3.1 pxc</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#10-1-3-2-mms"><span class="toc-text">10.1.3.2 mms</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-2-%E6%B5%8B%E8%AF%95%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8HA"><span class="toc-text">10.2 测试整体架构的高可用HA</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#10-2-1-%E6%A8%A1%E6%8B%9F%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AE%BF%E9%97%AE"><span class="toc-text">10.2.1 模拟客户端访问</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-2-2-%E6%A8%A1%E6%8B%9Fhaproxy-01%E5%AE%95%E6%8E%89"><span class="toc-text">10.2.2 模拟haproxy_01宕掉</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-2-3-%E6%A8%A1%E6%8B%9Fmycat-01%E5%AE%95%E6%9C%BA"><span class="toc-text">10.2.3 模拟mycat_01宕机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-2-4-%E6%A8%A1%E6%8B%9Fpxc-node1%E5%AE%95%E6%9C%BA"><span class="toc-text">10.2.4 模拟pxc_node1宕机</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-3-%E6%80%BB%E7%BB%93"><span class="toc-text">10.3 总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3"><span class="toc-text">参考文档</span></a></li></ol>
              <a href="#" id="article-toc-top">Back to Top</a>
            </div>
          </aside>
        </div>
      </article>
      <aside id="sidebar" role="navigation">
  <div class="inner">
    <strong class="sidebar-title">MySQL</strong><a href="/database/mysql/index.html" class="sidebar-link">概览</a><a href="/database/mysql/booboo_mysql/index.html" class="sidebar-link">MySQL 基础</a><a href="/database/mysql/dba_mysql/index.html" class="sidebar-link">MySQL 运维实践</a><a href="/database/mysql/rds_mysql/index.html" class="sidebar-link">RDS 性能调优</a><a href="/database/mysql/security/index.html" class="sidebar-link">安全篇</a><a href="/database/mysql/awesome-tools/index.html" class="sidebar-link">工具篇</a><strong class="sidebar-title">Oracle</strong><a href="/database/oracle/index.html" class="sidebar-link">概览</a><a href="/database/oracle/ocp/index.html" class="sidebar-link">Oracle12C OCP</a><a href="/database/oracle/oracle-12c/index.html" class="sidebar-link">Oracle 12c 学习笔记</a><a href="/database/oracle/oracle-11g/index.html" class="sidebar-link">Oracle 11g 学习笔记</a><strong class="sidebar-title">NoSQL</strong><a href="/database/nosql/index.html" class="sidebar-link">概览</a><a href="/database/nosql/booboo_redis/index.html" class="sidebar-link">Redis 基础</a><a href="/database/nosql/dba_redis/index.html" class="sidebar-link">Redis 进阶</a><a href="/database/nosql/booboo_mongodb/index.html" class="sidebar-link">MongoDB 基础</a><a href="/database/nosql/hadoop/index.html" class="sidebar-link">Hadoop 基础</a><strong class="sidebar-title">TiDB</strong><a href="/database/tidb/index.html" class="sidebar-link">概览</a><a href="/database/tidb/00_tidb入门指南.html" class="sidebar-link">TiDB 入门指南</a><a href="/database/tidb/01_raft协议理解.html" class="sidebar-link">Raft协议理解</a><a href="/database/tidb/tidb_courses/index.html" class="sidebar-link">TiDB 21天课程</a>
  </div>
</aside>
    </div>
  </div>
</div>

    <footer id="footer" class="wrapper">
  <div class="inner">
    <div id="footer-copyright">
      &copy; 2025 <a href="https://github.com/BoobooWei" target="_blank">魏亚萍</a><br>
      Documentation licensed under <a href="http://creativecommons.org/licenses/by/4.0/" target="_blank">CC BY 4.0</a>.<br>
      备案号：沪ICP备2020026043号
    </div>
    <div id="footer-links">
      <a href="https://www.youtube.com/@amyreading2023" class="footer-link" target="_blank">
        <img src="https://upload.wikimedia.org/wikipedia/commons/b/b8/YouTube_Logo_2017.svg" 
            alt="YouTube"
            style="height:24px; margin-bottom:-6px;">
      </a>
      <a href="https://github.com/BoobooWei" class="footer-link" target="_blank"><i class="fa fa-github-alt"></i></a>
    </div>
  </div>
</footer>

  </div>
  <div id="mobile-nav-dimmer"></div>
  <nav id="mobile-nav">
  <div id="mobile-nav-inner">
    <ul id="mobile-nav-list">
      <a href="../../../../docs/" class="mobile-nav-link">Hexo</a><a href="../../../../news/" class="mobile-nav-link">News</a><a href="../../../../api/" class="mobile-nav-link">MySQL8.0</a><a href="../../../../database/" class="mobile-nav-link">Database</a><a href="../../../../linux/" class="mobile-nav-link">Linux</a><a href="../../../../cloud/" class="mobile-nav-link">Cloud</a><a href="../../../../singapore/" class="mobile-nav-link">Singapore</a><a href="../../../../amy/" class="mobile-nav-link">AMY</a><a href="../../../../about/" class="mobile-nav-link">About</a>
      <li class="mobile-nav-item">
        <a href="https://github.com/BoobooWei" class="mobile-nav-link" rel="external" target="_blank">GitHub</a>
      </li>
    </ul>
    
      <strong class="mobile-nav-title">MySQL</strong><a href="/database/mysql/index.html" class="mobile-nav-link">概览</a><a href="/database/mysql/booboo_mysql/index.html" class="mobile-nav-link">MySQL 基础</a><a href="/database/mysql/dba_mysql/index.html" class="mobile-nav-link">MySQL 运维实践</a><a href="/database/mysql/rds_mysql/index.html" class="mobile-nav-link">RDS 性能调优</a><a href="/database/mysql/security/index.html" class="mobile-nav-link">安全篇</a><a href="/database/mysql/awesome-tools/index.html" class="mobile-nav-link">工具篇</a><strong class="mobile-nav-title">Oracle</strong><a href="/database/oracle/index.html" class="mobile-nav-link">概览</a><a href="/database/oracle/ocp/index.html" class="mobile-nav-link">Oracle12C OCP</a><a href="/database/oracle/oracle-12c/index.html" class="mobile-nav-link">Oracle 12c 学习笔记</a><a href="/database/oracle/oracle-11g/index.html" class="mobile-nav-link">Oracle 11g 学习笔记</a><strong class="mobile-nav-title">NoSQL</strong><a href="/database/nosql/index.html" class="mobile-nav-link">概览</a><a href="/database/nosql/booboo_redis/index.html" class="mobile-nav-link">Redis 基础</a><a href="/database/nosql/dba_redis/index.html" class="mobile-nav-link">Redis 进阶</a><a href="/database/nosql/booboo_mongodb/index.html" class="mobile-nav-link">MongoDB 基础</a><a href="/database/nosql/hadoop/index.html" class="mobile-nav-link">Hadoop 基础</a><strong class="mobile-nav-title">TiDB</strong><a href="/database/tidb/index.html" class="mobile-nav-link">概览</a><a href="/database/tidb/00_tidb入门指南.html" class="mobile-nav-link">TiDB 入门指南</a><a href="/database/tidb/01_raft协议理解.html" class="mobile-nav-link">Raft协议理解</a><a href="/database/tidb/tidb_courses/index.html" class="mobile-nav-link">TiDB 21天课程</a>
    
  </div>
  <div id="mobile-lang-select-wrap">
    <span id="mobile-lang-select-label"><i class="fa fa-globe"></i><span>English</span></span>
    <select id="mobile-lang-select" data-canonical="">
      
        <option value="en" selected>English</option>
      
    </select>
  </div>
</nav>
  <!-- Scripts -->
<!-- Cookie -->
<script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
<!-- build:js build/js/main.js -->

<script src="../../../../js/lang_select.js"></script>


<script src="../../../../js/mobile_nav.js"></script>

<!-- endbuild -->

<!-- Algolia -->
<!--   backup
<script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script>
<script type="text/javascript">
docsearch({
  appId: '',
  apiKey: '',
  indexName: '',
  insights: true,
  container: '#docsearch',
  debug: false,
  searchParameters: {
    facetFilters: ['lang:en']
  }
});
</script>
-->

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script type="text/javascript">
document.getElementById('search-input-wrap').classList.add('on');
docsearch({
    apiKey: '',
    indexName: '',
    inputSelector: '#search-input'
});
</script>
</body>
</html>